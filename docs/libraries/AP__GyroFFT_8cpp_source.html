<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>APM:Libraries: libraries/AP_GyroFFT/AP_GyroFFT.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">APM:Libraries
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bc0718b08fb2015b8e59c47b2805f60c.html">libraries</a></li><li class="navelem"><a class="el" href="dir_d9c6c28767f7ca721f38f06e8c039eae.html">AP_GyroFFT</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">AP_GyroFFT.cpp</div></div>
</div><!--header-->
<div class="contents">
<a href="AP__GyroFFT_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">/*</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">   This program is free software: you can redistribute it and/or modify</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">   it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">   the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment">   (at your option) any later version.</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment"></span> </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">   This program is distributed in the hope that it will be useful,</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">   GNU General Public License for more details.</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment"></span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">   You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">   along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment"></span> </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">   Code by Andy Piper with help from betaflight</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment"> */</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span> </div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="preprocessor">#include &quot;<a class="code" href="AP__GyroFFT_8h.html">AP_GyroFFT.h</a>&quot;</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="preprocessor">#if HAL_GYROFFT_ENABLED</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span> </div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="preprocessor">#include &lt;<a class="code" href="GCS_8h.html">GCS_MAVLink/GCS.h</a>&gt;</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="preprocessor">#include &lt;<a class="code" href="AP__Logger_8h.html">AP_Logger/AP_Logger.h</a>&gt;</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="preprocessor">#include &lt;<a class="code" href="HarmonicNotchFilter_8h.html">Filter/HarmonicNotchFilter.h</a>&gt;</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="preprocessor">#include &lt;<a class="code" href="AP__BoardConfig_8h.html">AP_BoardConfig/AP_BoardConfig.h</a>&gt;</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="preprocessor">#include &lt;<a class="code" href="AP__Arming_8h.html">AP_Arming/AP_Arming.h</a>&gt;</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="preprocessor">#include &lt;<a class="code" href="AP__Vehicle_8h.html">AP_Vehicle/AP_Vehicle.h</a>&gt;</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="preprocessor">#if APM_BUILD_COPTER_OR_HELI || APM_BUILD_TYPE(APM_BUILD_ArduPlane)</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="preprocessor">#include &lt;<a class="code" href="AP__Motors_8h.html">AP_Motors/AP_Motors.h</a>&gt;</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html">stdio.h</a>&gt;</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span> </div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="keyword">extern</span> <span class="keyword">const</span> <a class="code hl_class" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>;</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span> </div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="preprocessor">#ifndef FFT_DEFAULT_WINDOW_SIZE</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="comment">// the H7 can cope with a longer length and these boards generally have BMI088 which needs a longer length</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="preprocessor">#if defined(STM32H7)</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span><span class="preprocessor">#define FFT_DEFAULT_WINDOW_SIZE     64</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="preprocessor">#define FFT_DEFAULT_WINDOW_SIZE     32</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span><span class="preprocessor">#ifndef FFT_DEFAULT_WINDOW_OVERLAP</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="preprocessor">#if defined(STM32H7)</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="preprocessor">#define FFT_DEFAULT_WINDOW_OVERLAP  0.75f</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span><span class="preprocessor">#define FFT_DEFAULT_WINDOW_OVERLAP  0.5f</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="preprocessor">#define FFT_THR_REF_DEFAULT         0.35f   </span><span class="comment">// the estimated throttle reference, 0 ~ 1</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span><span class="preprocessor">#define FFT_SNR_DEFAULT             25.0f   </span><span class="comment">// a higher SNR is safer and this works quite well on a Pixracer</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span><span class="preprocessor">#define FFT_SNR_PFILT_DEFAULT       10.0f   </span><span class="comment">// post-filter there is much less noise so default should be lower</span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="preprocessor">#define FFT_STACK_SIZE              1024</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="preprocessor">#define FFT_MIN_SAMPLES_PER_FRAME   16</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="preprocessor">#define FFT_HARMONIC_FIT_DEFAULT    10</span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="preprocessor">#define FFT_HARMONIC_FIT_FILTER_HZ  15.0f</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span><span class="preprocessor">#define FFT_HARMONIC_FIT_MULT       50.0f</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span><span class="preprocessor">#define FFT_HARMONIC_FIT_TRACK_ROLL    4</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span><span class="preprocessor">#define FFT_HARMONIC_FIT_TRACK_PITCH   5</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="comment">// table of user settable parameters</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span><span class="keyword">const</span> <a class="code hl_struct" href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a> AP_GyroFFT::var_info[] = {</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span> </div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>    <span class="comment">// @Param: ENABLE</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>    <span class="comment">// @DisplayName: Enable</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    <span class="comment">// @Description: Enable Gyro FFT analyser</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>    <span class="comment">// @Values: 0:Disabled,1:Enabled</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>    <a class="code hl_define" href="AP__Param_8h.html#ac24e2eb16c2194e975d27e47ddcb7f1c">AP_GROUPINFO_FLAGS</a>(<span class="stringliteral">&quot;ENABLE&quot;</span>, 1, AP_GyroFFT, _enable, 0, <a class="code hl_define" href="AP__Param_8h.html#ae25c1c7495435989f8be5781c86be078">AP_PARAM_FLAG_ENABLE</a>),</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span> </div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>    <span class="comment">// @Param: MINHZ</span></div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>    <span class="comment">// @DisplayName: Minimum Frequency</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>    <span class="comment">// @Description: Lower bound of FFT frequency detection in Hz. On larger vehicles the minimum motor frequency is likely to be significantly lower than for smaller vehicles.</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>    <span class="comment">// @Range: 20 400</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>    <span class="comment">// @Units: Hz</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;MINHZ&quot;</span>, 2, AP_GyroFFT, _fft_min_hz, 50),</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span> </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>    <span class="comment">// @Param: MAXHZ</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>    <span class="comment">// @DisplayName: Maximum Frequency</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>    <span class="comment">// @Description: Upper bound of FFT frequency detection in Hz. On smaller vehicles the maximum motor frequency is likely to be significantly higher than for larger vehicles.</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>    <span class="comment">// @Range: 20 495</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>    <span class="comment">// @Units: Hz</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;MAXHZ&quot;</span>, 3, AP_GyroFFT, _fft_max_hz, 450),</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span> </div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>    <span class="comment">// @Param: SAMPLE_MODE</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>    <span class="comment">// @DisplayName: Sample Mode</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>    <span class="comment">// @Description: Sampling mode (and therefore rate). 0: Gyro rate sampling, 1: Fast loop rate sampling, 2: Fast loop rate / 2 sampling, 3: Fast loop rate / 3 sampling. Takes effect on reboot.</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>    <span class="comment">// @Range: 0 4</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;SAMPLE_MODE&quot;</span>, 4, AP_GyroFFT, _sample_mode, 0),</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span> </div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>    <span class="comment">// @Param: WINDOW_SIZE</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>    <span class="comment">// @DisplayName: FFT window size</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>    <span class="comment">// @Description: Size of window to be used in FFT calculations. Takes effect on reboot. Must be a power of 2 and between 32 and 512. Larger windows give greater frequency resolution but poorer time resolution, consume more CPU time and may not be appropriate for all vehicles. Time and frequency resolution are given by the sample-rate / window-size. Windows of 256 are only really recommended for F7 class boards, windows of 512 or more H7 class.</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>    <span class="comment">// @Range: 32 1024</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;WINDOW_SIZE&quot;</span>, 5, AP_GyroFFT, _window_size, FFT_DEFAULT_WINDOW_SIZE),</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span> </div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>    <span class="comment">// @Param: WINDOW_OLAP</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>    <span class="comment">// @DisplayName: FFT window overlap</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>    <span class="comment">// @Description: Percentage of window to be overlapped before another frame is process. Takes effect on reboot. A good default is 50% overlap. Higher overlap results in more processed frames but not necessarily more temporal resolution. Lower overlap results in lost information at the frame edges.</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>    <span class="comment">// @Range: 0 0.9</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;WINDOW_OLAP&quot;</span>, 6, AP_GyroFFT, _window_overlap, FFT_DEFAULT_WINDOW_OVERLAP),</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span> </div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>    <span class="comment">// @Param: FREQ_HOVER</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    <span class="comment">// @DisplayName: FFT learned hover frequency</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>    <span class="comment">// @Description: The learned hover noise frequency</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>    <span class="comment">// @Range: 0 250</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;FREQ_HOVER&quot;</span>, 7, AP_GyroFFT, _freq_hover_hz, 80.0f),</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span> </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>    <span class="comment">// @Param: THR_REF</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>    <span class="comment">// @DisplayName: FFT learned thrust reference</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    <span class="comment">// @Description: FFT learned thrust reference for the hover frequency and FFT minimum frequency.</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>    <span class="comment">// @Range: 0.01 0.9</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;THR_REF&quot;</span>, 8, AP_GyroFFT, _throttle_ref, FFT_THR_REF_DEFAULT),</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span> </div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>    <span class="comment">// @Param: SNR_REF</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>    <span class="comment">// @DisplayName: FFT SNR reference threshold</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>    <span class="comment">// @Description: FFT SNR reference threshold in dB at which a signal is determined to be present.</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>    <span class="comment">// @Range: 0.0 100.0</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;SNR_REF&quot;</span>, 9, AP_GyroFFT, _snr_threshold_db, FFT_SNR_DEFAULT),</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span> </div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>    <span class="comment">// @Param: ATT_REF</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>    <span class="comment">// @DisplayName: FFT attenuation for bandwidth calculation</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>    <span class="comment">// @Description: FFT attenuation level in dB for bandwidth calculation and peak detection. The bandwidth is calculated by comparing peak power output with the attenuated version. The default of 15 has shown to be a good compromise in both simulations and real flight.</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    <span class="comment">// @Range: 0 100</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;ATT_REF&quot;</span>, 10, AP_GyroFFT, _attenuation_power_db, 15),</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span> </div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>    <span class="comment">// @Param: BW_HOVER</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    <span class="comment">// @DisplayName: FFT learned bandwidth at hover</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    <span class="comment">// @Description: FFT learned bandwidth at hover for the attenuation frequencies.</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>    <span class="comment">// @Range: 0 200</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;BW_HOVER&quot;</span>, 11, AP_GyroFFT, _bandwidth_hover_hz, 20),</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span> </div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>    <span class="comment">// @Param: HMNC_FIT</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>    <span class="comment">// @DisplayName: FFT harmonic fit frequency threshold</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>    <span class="comment">// @Description: FFT harmonic fit frequency threshold percentage at which a signal of the appropriate frequency is determined to be the harmonic of another. Signals that have a harmonic relationship that varies at most by this percentage are considered harmonics of each other for the purpose of selecting the harmonic notch frequency. If a match is found then the lower frequency harmonic is always used as the basis for the dynamic harmonic notch. A value of zero completely disables harmonic matching.</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>    <span class="comment">// @Range: 0 100</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;HMNC_FIT&quot;</span>, 12, AP_GyroFFT, _harmonic_fit, FFT_HARMONIC_FIT_DEFAULT),</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span> </div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>    <span class="comment">// @Param: HMNC_PEAK</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>    <span class="comment">// @DisplayName: FFT harmonic peak target</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>    <span class="comment">// @Description: The FFT harmonic peak target that should be returned by FTN1.PkAvg. The resulting value will be used by the harmonic notch if configured to track the FFT frequency. By default the appropriate peak is auto-detected based on the harmonic fit between peaks and the energy-weighted average frequency on roll on pitch is used. Setting this to 1 will always target the highest energy peak. Setting this to 2 will target the highest energy peak that is lower in frequency than the highest energy peak. Setting this to 3 will target the highest energy peak that is higher in frequency than the highest energy peak. Setting this to 4 will target the highest energy peak on the roll axis only and only the roll frequency will be used (some vehicles have a much more pronounced peak on roll). Setting this to 5 will target the highest energy peak on the pitch axis only and only the pitch frequency will be used (some vehicles have a much more pronounced peak on roll).</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>    <span class="comment">// @Values: 0:Auto,1:Center Frequency,2:Lower-Shoulder Frequency,3:Upper-Shoulder Frequency,4:Roll-Axis,5:Pitch-Axis</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;HMNC_PEAK&quot;</span>, 13, AP_GyroFFT, _harmonic_peak, 0),</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>    <span class="comment">// @Param: NUM_FRAMES</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    <span class="comment">// @DisplayName: FFT output frames to retain and average</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>    <span class="comment">// @Description: Number of output frequency frames to retain and average in order to calculate final frequencies. Averaging output frames can drastically reduce noise and jitter at the cost of latency as long as the input is stable. The default is to perform no averaging. For rapidly changing frequencies (e.g. smaller aircraft) fewer frames should be averaged.</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>    <span class="comment">// @Range: 0 8</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;NUM_FRAMES&quot;</span>, 14, AP_GyroFFT, _num_frames, 0),</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span> </div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>    <span class="comment">// @Param: OPTIONS</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>    <span class="comment">// @DisplayName: FFT options</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>    <span class="comment">// @Description: FFT configuration options. Values: 1:Apply the FFT *after* the filter bank,2:Check noise at the motor frequencies using ESC data as a reference</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>    <span class="comment">// @Bitmask: 0:Enable post-filter FFT,1:Check motor noise</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>    <span class="comment">// @User: Advanced</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>    <span class="comment">// @RebootRequired: True</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>    <a class="code hl_define" href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a>(<span class="stringliteral">&quot;OPTIONS&quot;</span>, 15, AP_GyroFFT, _options, 0),</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>    <a class="code hl_define" href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>};</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span> </div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="comment">// The FFT splits the frequency domain into an number of bins</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span><span class="comment">// A sampling frequency of 1000 and max frequency (Nyquist) of 500 at a window size of 32 gives 16 frequency bins each 31.25Hz wide</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="comment">// The first bin is used to store the DC and Nyquist values combined.</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span><span class="comment">// Eg [DC/Nyquist], [16,47), [47,78), [78,109) etc</span></div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="comment">// For a loop rate of 800Hz, 16 bins each 25Hz wide</span></div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span><span class="comment">// Eg X[0]=[DC/Nyquist], X[1]=[12,37), X[2]=[37,62), X[3]=[62,87), X[4]=[87,112)</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span><span class="comment">// So middle frequency is X[n] * 25 and the range is X[n] * 25 - 12 &lt; f &lt; X[n] * 25 + 12</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="keyword">const</span> <span class="keyword">extern</span> <a class="code hl_class" href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a>&amp; <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>;</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span> </div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>AP_GyroFFT::AP_GyroFFT()</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>{</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>    _thread_state._noise_needs_calibration = 0x07; <span class="comment">// all axes need calibration</span></div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>    <a class="code hl_function" href="classAP__Param.html#a5f6dcfce1c0a79cf5bd81283e22f3201">AP_Param::setup_object_defaults</a>(<span class="keyword">this</span>, var_info);</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span> </div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>    <span class="keywordflow">if</span> (_singleton != <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a52edeef7d5ffaa365e1229b87c170307">AP_HAL::panic</a>(<span class="stringliteral">&quot;AP_GyroFFT must be singleton&quot;</span>);</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>    }</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>    _singleton = <span class="keyword">this</span>;</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>}</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span> </div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="comment">// initialize the FFT parameters and engine</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span><span class="keywordtype">void</span> AP_GyroFFT::init(uint16_t loop_rate_hz)</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>{</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>    <span class="comment">// if FFT analysis is not enabled we don&#39;t want to allocate any of the associated resources</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>    <span class="keywordflow">if</span> (!_enable) {</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>    }</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span> </div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>    _ins = &amp;<a class="code hl_function" href="namespaceAP.html#ac571aa5a2ef71b7f4b4b2bfa09143fb9">AP::ins</a>();</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span> </div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>    <span class="comment">// sanity check</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>    <span class="keywordflow">if</span> (_ins-&gt;get_raw_gyro_rate_hz() == 0) {</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a52edeef7d5ffaa365e1229b87c170307">AP_HAL::panic</a>(<span class="stringliteral">&quot;AP_GyroFFT must be initialized after AP_InertialSensor&quot;</span>);</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>    }</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span> </div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>    <span class="comment">// check that we support the window size requested and it is a power of 2</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>    _window_size.set(1 &lt;&lt; lrintf(log2f(_window_size.get())));</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span><span class="preprocessor">#if defined(STM32H7) || CONFIG_HAL_BOARD == HAL_BOARD_LINUX || CONFIG_HAL_BOARD == HAL_BOARD_SITL</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>    _window_size.set(<a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(_window_size, 32, 512));</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>    _window_size.set(<a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(_window_size, 32, 256));</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>    <span class="comment">// number of samples needed before a new frame can be processed</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>    _window_overlap.set(<a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_window_overlap, 0.0f, 0.9f));</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>    _samples_per_frame = (1.0f - _window_overlap) * _window_size;</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>    <span class="comment">// if we allow too small a number of samples per frame the output rate gets very high</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>    <span class="comment">// this is particularly a problem on IMUs with higher sample rates (e.g. BMI088)</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    <span class="comment">// 16 gives a maximum output rate of 2Khz / 16 = 125Hz per axis or 375Hz in aggregate</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>    _samples_per_frame = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(FFT_MIN_SAMPLES_PER_FRAME, 1 &lt;&lt; lrintf(log2f(_samples_per_frame)));</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>    <span class="keywordflow">if</span> (_num_frames &gt; 0) {</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>        _num_frames.set(<a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(_num_frames, 2, AP_HAL::DSP::MAX_SLIDING_WINDOW_SIZE));</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>    }</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span> </div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>    <span class="comment">// check that we have enough memory for the window size requested</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>    <span class="comment">// INS: XYZ_AXIS_COUNT * INS_MAX_INSTANCES * _window_size, DSP: 3 * _window_size, FFT: XYZ_AXIS_COUNT + 3 * _window_size</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>    <span class="keyword">const</span> uint32_t allocation_count = (<a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a> * <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a2247b51f4c9a78d7d1f06d7dda78a82e">INS_MAX_INSTANCES</a> + 3 + <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a> + 3 + _num_frames) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>    <span class="keywordflow">if</span> (allocation_count * FFT_DEFAULT_WINDOW_SIZE &gt; <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#a2a2e64f649d25593951054d44c0ed53b">available_memory</a>() / 2) {</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;AP_GyroFFT: disabled, required %u bytes&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)allocation_count * FFT_DEFAULT_WINDOW_SIZE);</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (allocation_count * _window_size &gt; <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#a2a2e64f649d25593951054d44c0ed53b">available_memory</a>() / 2) {</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;AP_GyroFFT: req alloc %u bytes (free=%u)&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)allocation_count * _window_size, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#a2a2e64f649d25593951054d44c0ed53b">available_memory</a>());</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>        _window_size.set(FFT_DEFAULT_WINDOW_SIZE);</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>    }</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>    <span class="comment">// save any changes that were made</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>    _window_size.save();</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span> </div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>    <span class="comment">// determine the FFT sample rate based on the gyro rate, loop rate and configuration</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>    <span class="keywordflow">if</span> (_sample_mode == 0) {</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>        _fft_sampling_rate_hz = _ins-&gt;get_raw_gyro_rate_hz();</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>        _fft_sampling_rate_hz = loop_rate_hz / _sample_mode;</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>        <span class="keywordflow">for</span> (uint8_t axis = 0; axis &lt; <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a>; axis++) {</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>            <span class="keywordflow">if</span> (!_downsampled_gyro_data[axis].set_size(_window_size + _samples_per_frame)) {</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>                <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;Failed to allocate window for AP_GyroFFT&quot;</span>);</div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>                <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>            }</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>        }</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>    }</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>    _current_sample_mode = _sample_mode;</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span> </div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>    _ref_energy = <span class="keyword">new</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>[_window_size];</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>    <span class="keywordflow">if</span> (_ref_energy == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;Failed to allocate window for AP_GyroFFT&quot;</span>);</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>    }</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span> </div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>    <span class="comment">// make the gyro window match the window size plus a buffer to cope with the backend</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>    <span class="comment">// getting too far ahead.</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>    <span class="keywordflow">if</span> (!_ins-&gt;set_gyro_window_size(_window_size + _samples_per_frame)) {</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>    }</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span> </div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>    <span class="comment">// check for harmonics across all harmonic notch filters</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>    <span class="comment">// note that we only allow one harmonic notch filter linked to the FFT code</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>    uint32_t harmonics = 0;</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>    uint8_t num_notches = 0;</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code hl_variable" href="TransferFunctionCheck_8cpp.html#a10bd73336f20a0e29b5e73449e790798">notch</a> : _ins-&gt;harmonic_notches) {</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>        <span class="keywordflow">if</span> (<a class="code hl_variable" href="TransferFunctionCheck_8cpp.html#a10bd73336f20a0e29b5e73449e790798">notch</a>.params.enabled()) {</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>            harmonics |= <a class="code hl_variable" href="TransferFunctionCheck_8cpp.html#a10bd73336f20a0e29b5e73449e790798">notch</a>.params.harmonics();</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>            num_notches = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(num_notches, <a class="code hl_variable" href="TransferFunctionCheck_8cpp.html#a10bd73336f20a0e29b5e73449e790798">notch</a>.num_dynamic_notches);</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>        }</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>    }</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>    <span class="keywordflow">if</span> (harmonics == 0) {</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>        <span class="comment">// this allows use of FFT to find peaks with all notch filters disabled</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>        harmonics = 3;</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>    }</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>    <span class="comment">// count the number of active harmonics or dynamic notchs</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>    _tracked_peaks = <a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(<a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(__builtin_popcount(harmonics),</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>                                         num_notches), 1, FrequencyPeak::MAX_TRACKED_PEAKS);</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span> </div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>    <span class="comment">// calculate harmonic multiplier. this assumes the harmonics configured on the </span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>    <span class="comment">// harmonic notch reflect the multiples of the fundamental harmonic that should be tracked</span></div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>    <span class="keywordflow">if</span> (_harmonic_fit &gt; 0) {</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>        uint8_t first_harmonic = 0;</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>        <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; <a class="code hl_define" href="HarmonicNotchFilter_8h.html#af1151dca8cefec4b426ce895493bcbcf">HNF_MAX_HARMONICS</a>; i++) {</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>            <span class="keywordflow">if</span> (harmonics &amp; (1&lt;&lt;i)) {</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>                <span class="keywordflow">if</span> (first_harmonic == 0) {</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>                    first_harmonic = i + 1;</div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>                } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>                    _harmonic_multiplier = float(i + 1) / first_harmonic;</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>                }</div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>            }</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>        }</div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>        <span class="comment">// if no harmonic specified then select a simple 2x multiple</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(_harmonic_multiplier)) {</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>            _harmonic_multiplier = 2.0f;</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>        }</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>    }</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span> </div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>    <span class="comment">// initialise the HAL DSP subsystem</span></div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>    _state = <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_init(_window_size, _fft_sampling_rate_hz, _num_frames);</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>    <span class="keywordflow">if</span> (_state == <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;Failed to initialize DSP engine&quot;</span>);</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>    }</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span> </div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>    <span class="comment">// per-axis frame time</span></div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>    _frame_time_ms = _samples_per_frame * 1000 / _fft_sampling_rate_hz;</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>    <span class="comment">// The update rate for the output, defaults are 1Khz / (1 - 0.5) * 32 == 62hz</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> output_rate = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_fft_sampling_rate_hz) / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_samples_per_frame);</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>    <span class="comment">// establish suitable defaults for the detected values</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>    <span class="keywordflow">for</span> (uint8_t axis = 0; axis &lt; <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a>; axis++) {</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>        _thread_state._center_freq_hz[axis] = _fft_min_hz;</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span> </div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>        <span class="keywordflow">for</span> (uint8_t peak = 0; peak &lt; FrequencyPeak::MAX_TRACKED_PEAKS; peak++) {</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>            _thread_state._center_freq_hz_filtered[axis][peak] = _fft_min_hz;</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>        }</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>        <span class="comment">// number of cycles to average over, two complete windows to be sure</span></div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>        _noise_calibration_cycles[axis] = (_window_size / _samples_per_frame) * 2;</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>        <span class="comment">// harmonic frequency fit should change relatively slowly</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>        _harmonic_fit_filter[axis].set_cutoff_frequency(output_rate, <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(output_rate * 0.48f, FFT_HARMONIC_FIT_FILTER_HZ));</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>    }</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span> </div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>    <span class="comment">// configure a filter for frequency, bandwidth and energy for each of the three tracked noise peaks</span></div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>    <span class="comment">// filter more aggressively post-filter since the noise is harder to detect</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> scale_factor = using_post_filter_samples() ? 0.1f : 1.0f;</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>    <span class="keywordflow">for</span> (uint8_t peak = 0; peak &lt; FrequencyPeak::MAX_TRACKED_PEAKS; peak++) {</div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>        <span class="comment">// calculate low-pass filter characteristics based on window size and overlap</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>        _center_freq_filter[peak].set_cutoff_frequency(output_rate, output_rate * 0.48f * scale_factor);</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>        <span class="comment">// the bin energy jumps around a lot so requires more filtering</span></div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>        _center_freq_energy_filter[peak].set_cutoff_frequency(output_rate, output_rate * 0.25f * scale_factor);</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>        <span class="comment">// smooth the bandwidth output more aggressively</span></div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>        _center_bandwidth_filter[peak].set_cutoff_frequency(output_rate, output_rate * 0.25f * scale_factor);</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>    }</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span> </div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>    <span class="comment">// turn down the SNR threshold if examining post-filter</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>    <span class="keywordflow">if</span> (using_post_filter_samples()) {</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>        _snr_threshold_db.set_default(FFT_SNR_PFILT_DEFAULT);</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>    }</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span> </div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>    <span class="comment">// the number of cycles required to have a proper noise reference</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>    _noise_cycles = (_window_size / _samples_per_frame) * <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a>;</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span> </div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>    <span class="comment">// finally we are done</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>    _initialized = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>    update_parameters(<span class="keyword">true</span>);</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>    <span class="comment">// start running FFTs</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>    <span class="keywordflow">if</span> (start_update_thread()) {</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>        set_analysis_enabled(<span class="keyword">true</span>);</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>    }</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>}</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span> </div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span><span class="comment">// sample the gyros either by using a gyro window sampled at the gyro rate or making individual samples</span></div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span><span class="comment">// called from fast_loop thread - this function does not take out a semaphore to avoid waiting on the FFT thread</span></div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span><span class="keywordtype">void</span> AP_GyroFFT::sample_gyros()</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>{</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>    }</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span> </div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>    <span class="comment">// update counters for gyro window</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>    <span class="keywordflow">if</span> (_current_sample_mode &gt; 0) {</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>        <span class="comment">// for loop rate sampling accumulate and average gyro samples</span></div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>        _oversampled_gyro_accum += _ins-&gt;get_gyro_for_fft();</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>        _oversampled_gyro_count++;</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>        <span class="keywordflow">if</span> ((_oversampled_gyro_count % _current_sample_mode) == 0) {</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>            <span class="comment">// calculate mean value of accumulated samples</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>            <a class="code hl_class" href="classVector3.html">Vector3f</a> sample = _oversampled_gyro_accum / _current_sample_mode;</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>            <span class="comment">// fast sampling means that the raw gyro values have already been averaged over 8 samples</span></div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>            _downsampled_gyro_data[0].push(sample.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>);</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>            _downsampled_gyro_data[1].push(sample.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>            _downsampled_gyro_data[2].push(sample.<a class="code hl_variable" href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">z</a>);</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>            _oversampled_gyro_accum.<a class="code hl_function" href="classVector3.html#adf1769d5ee5df2f8585df2f540fa5efe">zero</a>();</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>            _oversampled_gyro_count = 0;</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>        }</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>    }</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>}</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span> </div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span><span class="comment">// update the state as as required</span></div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span><span class="comment">// called from main thread at 400Hz - anything that requires atomic access to IMU data needs to be done here</span></div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span><span class="keywordtype">void</span> AP_GyroFFT::update()</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>{</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>    }</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span> </div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>    <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span> </div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>    _config._analysis_enabled = _analysis_enabled;</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>    _global_state = _thread_state;</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span> </div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>    <span class="comment">// calculate health based on being 5 frames behind, SITL needs longer</span></div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span><span class="preprocessor">#if CONFIG_HAL_BOARD == HAL_BOARD_SITL</span></div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>    <span class="keyword">const</span> uint32_t output_delay = _frame_time_ms * <a class="code hl_define" href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a> * 2;</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>    <span class="keyword">const</span> uint32_t output_delay = _frame_time_ms * <a class="code hl_define" href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a>;</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>    uint32_t now = <a class="code hl_function" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>    _rpy_health.x = (now - _global_state._health_ms.x &lt;= output_delay);</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>    _rpy_health.y = (now - _global_state._health_ms.y &lt;= output_delay);</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>    _rpy_health.z = (now - _global_state._health_ms.z &lt;= output_delay);</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span> </div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>    _health = _global_state._health;</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>    <span class="keywordflow">if</span> (!_rpy_health.x) {</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>        _health.x = 0;</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>    }</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>    <span class="keywordflow">if</span> (!_rpy_health.y) {</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>        _health.y = 0;</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>    }</div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>    <span class="keywordflow">if</span> (!_rpy_health.z) {</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>        _health.z = 0;</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>    }</div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>}</div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span> </div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="comment">// analyse gyro data using FFT, returns number of samples still held</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span><span class="comment">// called from FFT thread</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>uint16_t AP_GyroFFT::run_cycle()</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>{</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>    }</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span> </div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>    <span class="keywordflow">if</span> (!_sem.take(<a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#ad664d2e6bf70a9194d608eb555dbcf8b">HAL_SEMAPHORE_BLOCK_FOREVER</a>)) {</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>    }</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span> </div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>    <span class="comment">// do we have enough samples for another pass?</span></div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>    <span class="keywordflow">if</span> (!start_analysis()) {</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>        uint16_t new_sample_count =  get_available_samples(_update_axis);</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>        _sem.give();</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>        <span class="keywordflow">return</span> new_sample_count;</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>    }</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span> </div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>    <span class="comment">// take a copy of the config inside the semaphore</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>    EngineConfig config = _config;</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span> </div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>    _sem.give();</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span> </div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>    uint32_t now = <a class="code hl_function" href="namespaceAP__HAL.html#a8293355e35887733b1fd151aef08a787">AP_HAL::micros</a>();</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span> </div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>    <span class="comment">// get the appropriate gyro buffer</span></div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>    <a class="code hl_class" href="classObjectBuffer.html">FloatBuffer</a>&amp; gyro_buffer = (_sample_mode == 0 ?_ins-&gt;get_raw_gyro_window(_update_axis) : _downsampled_gyro_data[_update_axis]);</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>    <span class="comment">// if we have many more samples than the window size then we are struggling to </span></div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>    <span class="comment">// stay ahead of the gyro loop so drop samples so that this cycle will use all available samples</span></div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>    <span class="keywordflow">if</span> (gyro_buffer.<a class="code hl_function" href="classObjectBuffer.html#ac7dda33e514a9c01c80a7a658cbe640e">available</a>() &gt; uint32_t(_state-&gt;_window_size + uint16_t(_samples_per_frame &gt;&gt; 1))) { <span class="comment">// half the frame size is a heuristic</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>        gyro_buffer.<a class="code hl_function" href="classObjectBuffer.html#a7bac73b321b960c979ac5def005a06f3">advance</a>(gyro_buffer.<a class="code hl_function" href="classObjectBuffer.html#ac7dda33e514a9c01c80a7a658cbe640e">available</a>() - _state-&gt;_window_size);</div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>    }</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>    <span class="comment">// let&#39;s go!</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>    <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_start(_state, gyro_buffer, _samples_per_frame);</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span> </div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>    <span class="comment">// calculate FFT and update filters outside the semaphore</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>    uint16_t bin_max = <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_analyse(_state, config._fft_start_bin, config._fft_end_bin, config._attenuation_cutoff);</div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span> </div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>    <span class="comment">// something has been detected, update the peak frequency and associated metrics</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>    update_ref_energy(bin_max);</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>    <a class="code hl_function" href="AP__InertialSensor__NONE_8cpp.html#a001d4b2e794347cc13cd554c67e2b585">calculate_noise</a>(<span class="keyword">false</span>, config);</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span> </div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>    <span class="comment">// record how we are doing</span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>    _thread_state._last_output_us[_update_axis] = <a class="code hl_function" href="namespaceAP__HAL.html#a8293355e35887733b1fd151aef08a787">AP_HAL::micros</a>();</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>    _output_cycle_micros = _thread_state._last_output_us[_update_axis] - now;</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span> </div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span><span class="preprocessor">#if AP_SIM_ENABLED &amp;&amp; HAL_LOGGING_ENABLED</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>    <span class="comment">// extra logging when running simulations</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>    <a class="code hl_function" href="namespaceAP.html#aa35bfac1ea2da16f110e8e72db7b3b20">AP::logger</a>().<a class="code hl_function" href="classAP__Logger.html#abab7cb26825a8dfb1e5e92cf7fcf4152">WriteStreaming</a>(</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>        <span class="stringliteral">&quot;FTN3&quot;</span>,</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>        <span class="stringliteral">&quot;TimeUS,Id,Pk1,Pk2,Pk3,Bw1,Bw2,Bw3,En1,En2,En3&quot;</span>,</div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>        <span class="stringliteral">&quot;s#zzzzzz---&quot;</span>,</div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>        <span class="stringliteral">&quot;F----------&quot;</span>,</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>        <span class="stringliteral">&quot;QBfffffffff&quot;</span>,</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a7aa0ce7625c9680e30ff4a99940907a5">AP_HAL::micros64</a>(),</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>        _update_axis,</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>        _state-&gt;_peak_data[0]._freq_hz,</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>        _state-&gt;_peak_data[1]._freq_hz,</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>        _state-&gt;_peak_data[2]._freq_hz,</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>        _state-&gt;_peak_data[0]._noise_width_hz,</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>        _state-&gt;_peak_data[1]._noise_width_hz,</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>        _state-&gt;_peak_data[2]._noise_width_hz,</div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>        _state-&gt;_freq_bins[_state-&gt;_peak_data[0]._bin],</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>        _state-&gt;_freq_bins[_state-&gt;_peak_data[1]._bin],</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>        _state-&gt;_freq_bins[_state-&gt;_peak_data[2]._bin]);</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span> </div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>    <span class="comment">// move onto the next axis</span></div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>    _update_axis = (_update_axis + 1) % <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a>;</div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span> </div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>    <span class="comment">// ready to receive another frame, because lock contention is so expensive we don&#39;t lock</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>    <span class="comment">// around this flag but rather rely on the semaphore at the beginning of the loop to</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>    <span class="comment">// ensure eventual visibility to the main loop</span></div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>    _thread_state._analysis_started = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span> </div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>    <span class="comment">// samples remaining in the next axis</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>    <span class="keywordflow">return</span> get_available_samples(_update_axis);</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>}</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span> </div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span><span class="comment">// whether analysis can be run again or not</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span><span class="comment">// called from FFT thread with the semaphore held</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span><span class="keywordtype">bool</span> AP_GyroFFT::start_analysis() {</div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>    <span class="keywordflow">if</span> (_thread_state._analysis_started) {</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>    }</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>    <span class="comment">// don&#39;t run any more gyro cycles once noise is calibrated and the self-test is running</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>    <span class="keywordflow">if</span> (!_thread_state._noise_needs_calibration &amp;&amp; !_calibrated) {</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>    }</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span> </div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>    <span class="keywordflow">if</span> (get_available_samples(_update_axis) &gt;= _state-&gt;_window_size) {</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>        _thread_state._analysis_started = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>    }</div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>}</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span> </div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span><span class="comment">// update calculated values of dynamic parameters - runs at 1Hz</span></div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span><span class="keywordtype">void</span> AP_GyroFFT::update_parameters(<span class="keywordtype">bool</span> force)</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>{</div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>    <span class="comment">// lock contention is very costly, so don&#39;t allow configuration updates while flying</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>    <span class="keywordflow">if</span> ((!_initialized || <a class="code hl_function" href="namespaceAP.html#a13852d97b041687ca5df7d76e7207a3d">AP::arming</a>().is_armed()) &amp;&amp; !force) {</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>    }</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span> </div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>    <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>    <span class="comment">// don&#39;t allow MAXHZ to go to Nyquist</span></div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>    _fft_max_hz.set(<a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(_fft_max_hz, _fft_sampling_rate_hz * 0.48));</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>    _config._snr_threshold_db = _snr_threshold_db;</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>    _config._fft_min_hz = _fft_min_hz;</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>    _config._fft_max_hz = _fft_max_hz;</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>    <span class="comment">// determine the start FFT bin for all frequency detection</span></div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>    _config._fft_start_bin = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(floorf(_fft_min_hz.get() / _state-&gt;_bin_resolution), 1);</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>    <span class="comment">// determine the endt FFT bin for all frequency detection</span></div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>    _config._fft_end_bin = <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(ceilf(_fft_max_hz.get() / _state-&gt;_bin_resolution), _state-&gt;_bin_count);</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>    <span class="comment">// actual attenuation from the db value</span></div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>    _config._attenuation_cutoff = powf(10.0f, -_attenuation_power_db * 0.1f);</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>}</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span> </div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span><span class="comment">// thread for processing gyro data via FFT</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span><span class="keywordtype">void</span> AP_GyroFFT::update_thread(<span class="keywordtype">void</span>)</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>{</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>        uint16_t remaining_samples = run_cycle();</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>        <span class="comment">// this is to stop us burning CPU while waiting for samples, the reduction by _samples_per_frame is a heuristic to prevent waiting too long</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>        <span class="comment">// and missing frames (easy to see in SITL because the noise will keep calibrating)</span></div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>        <span class="comment">// we always delay by at least 1us to give logging a chance to run at the same priority</span></div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>        uint32_t delay = <a class="code hl_function" href="AP__Math_8h.html#a40141a958e445f6293a659e856c49f55">constrain_int32</a>((int16_t)_state-&gt;_window_size - (int16_t)remaining_samples, 0, _samples_per_frame)</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>            * 1e6 / _fft_sampling_rate_hz;</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span><span class="preprocessor">#if CONFIG_HAL_BOARD == HAL_BOARD_SITL</span></div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>        <span class="comment">// in SITL the gyros do not run in a different thread</span></div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>        <span class="keywordflow">if</span> (delay &gt; 0) {</div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>            <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">scheduler</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Scheduler.html#a78c4f1b1f192ac1c99544b6cc8f099b0">delay_microseconds</a>(delay);</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>        }</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">scheduler</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Scheduler.html#a78c4f1b1f192ac1c99544b6cc8f099b0">delay_microseconds</a>(<a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(delay, 1U));</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>    }</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>}</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span> </div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span><span class="comment">// start the update thread</span></div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span><span class="keywordtype">bool</span> AP_GyroFFT::start_update_thread(<span class="keywordtype">void</span>)</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>{</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>    <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span> </div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>    <span class="keywordflow">if</span> (_thread_created) {</div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>    }</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span> </div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">scheduler</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Scheduler.html#aa6ce504fcdbd583bc7c05eb1f1fb2129">thread_create</a>(<a class="code hl_define" href="functor_8h.html#a00e5874203cecc310017f9166f2c0e36">FUNCTOR_BIND_MEMBER</a>(&amp;AP_GyroFFT::update_thread, <span class="keywordtype">void</span>), <span class="stringliteral">&quot;apm_fft&quot;</span>, FFT_STACK_SIZE, <a class="code hl_enumvalue" href="classAP__HAL_1_1Scheduler.html#abcee0d195c8bec8bcbe39f3ef6edbf16a85a843892d64d34a41f0c9914e4c6610">AP_HAL::Scheduler::PRIORITY_IO</a>, 0)) {</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a52edeef7d5ffaa365e1229b87c170307">AP_HAL::panic</a>(<span class="stringliteral">&quot;Failed to start AP_GyroFFT update thread&quot;</span>);</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>    }</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span> </div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>    _thread_created = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>}</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span> </div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span><span class="comment">// self-test the FFT analyser - can only be done while samples are not being taken</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span><span class="keywordtype">bool</span> AP_GyroFFT::pre_arm_check(<span class="keywordtype">char</span> *failure_msg, <span class="keyword">const</span> uint8_t failure_msg_len)</div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>{</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>    }</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span> </div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>    <span class="comment">// already calibrated</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>    <span class="keywordflow">if</span> (_calibrated) {</div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>    }</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span> </div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>    <span class="comment">// analysis is started in the main thread, don&#39;t trample on in-flight analysis</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>    <span class="keywordflow">if</span> (_global_state._analysis_started) {</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#afaedff8102d9ae2fbc398d2099e30cf6">snprintf</a>(failure_msg, failure_msg_len, <span class="stringliteral">&quot;FFT still analyzing&quot;</span>);</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>    }</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span> </div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>    <span class="comment">// still calibrating noise so not ready</span></div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>    <span class="keywordflow">if</span> (_global_state._noise_needs_calibration) {</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#afaedff8102d9ae2fbc398d2099e30cf6">snprintf</a>(failure_msg, failure_msg_len, <span class="stringliteral">&quot;FFT calibrating noise&quot;</span>);</div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>    }</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span> </div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>    <span class="comment">// make sure the frequency maximum is below Nyquist</span></div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>    <span class="keywordflow">if</span> (_fft_max_hz &gt; _fft_sampling_rate_hz * 0.5f) {</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#afaedff8102d9ae2fbc398d2099e30cf6">snprintf</a>(failure_msg, failure_msg_len, <span class="stringliteral">&quot;FFT config MAXHZ %dHz &gt; %dHz&quot;</span>, _fft_max_hz.get(), _fft_sampling_rate_hz / 2);</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>    }</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span> </div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>    <span class="comment">// check for sane frequency resolution - for 1k backends with length 32 this will be 32Hz</span></div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span>    <span class="keywordflow">if</span> (_state-&gt;_bin_resolution &gt; 50.0f) {</div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: resolution is %.1fHz, increase length&quot;</span>, _state-&gt;_bin_resolution);</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// a low resolution is not fatal</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>    }</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span><span class="preprocessor">#if 0 </span><span class="comment">// these calculations do not result in a long enough expected delay</span></div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>    <span class="comment">// in order to test all frequencies we need to endure a long pause for higher windows lengths</span></div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>    <span class="comment">// see timings AP_HAL_ChibiOS/DSP.cpp for per step timings on different hardware</span></div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span><span class="preprocessor">#if defined(STM32H7)</span></div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>    <span class="keyword">const</span> uint32_t cycle_time = (16 * (1 &lt;&lt; (_window_size / 32)) + 5) * (_config._fft_end_bin - _config._fft_start_bin + 1) * 2 / 1000; <span class="comment">// H7</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>    <span class="keyword">const</span> uint32_t cycle_time = (29 * (1 &lt;&lt; (_window_size / 32)) + 5) * (_config._fft_end_bin - _config._fft_start_bin + 1) * 2 / 1000; <span class="comment">// F4</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>    <a class="code hl_define" href="AP__HAL_2Scheduler_8h.html#a538ef95a13e6bf98cc2e008c2a8b9a44">EXPECT_DELAY_MS</a>(2000); <span class="comment">// tested on an H7 at 1024 window</span></div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span> </div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>    <span class="keywordtype">float</span> max_divergence = self_test_bin_frequencies();</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>    <span class="comment">// for longer FFT lengths the resolution gets below 1Hz</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>    <span class="keywordflow">if</span> (max_divergence &gt; <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(_state-&gt;_bin_resolution * 0.5f, 1)) {</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#afaedff8102d9ae2fbc398d2099e30cf6">snprintf</a>(failure_msg, failure_msg_len, <span class="stringliteral">&quot;FFT self-test failed, max error %fHz&quot;</span>, max_divergence);</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>    }</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span> </div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>    _calibrated =  max_divergence &lt;= <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(_state-&gt;_bin_resolution * 0.5f, 1);</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span> </div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>    <span class="keywordflow">if</span> (_calibrated) {</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>        <span class="comment">// provide the user with some useful information about what they have configured</span></div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_INFO, <span class="stringliteral">&quot;FFT: calibrated %.1fKHz/%.1fHz/%.1fHz&quot;</span>, _fft_sampling_rate_hz * 0.001f,</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>             _state-&gt;_bin_resolution * 0.5, 1000.0f * <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a> / _frame_time_ms);</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>    }</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span> </div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>    <span class="keywordflow">return</span> _calibrated;</div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>}</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span> </div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span><span class="comment">// we may have disabled the FFT arming check, in which case make sure the engine can still run</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span><span class="keywordtype">bool</span> AP_GyroFFT::prepare_for_arming()</div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>{</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>    _calibrated = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>}</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span> </div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span><span class="comment">// update the hover frequency input filter. should be called at 100hz when in a stable hover</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span><span class="keywordtype">void</span> AP_GyroFFT::update_freq_hover(<span class="keywordtype">float</span> dt, <span class="keywordtype">float</span> throttle_out)</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>{</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>    }</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span> </div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>    <span class="comment">// throttle averaging for average fft calculation</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(_avg_throttle_out)) {</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>        _avg_throttle_out = throttle_out;</div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>        _avg_throttle_out = <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_avg_throttle_out + (dt / (10.0f + dt)) * (throttle_out - _avg_throttle_out), 0.01f, 0.9f);</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>    }</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span> </div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>    <span class="comment">// we have chosen to constrain the hover frequency to be within the range reachable by the third order expo polynomial.</span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>    _freq_hover_hz.set(<a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_freq_hover_hz + (dt / (10.0f + dt)) * (get_weighted_noise_center_freq_hz() - _freq_hover_hz), _fft_min_hz, _fft_max_hz));</div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>    _bandwidth_hover_hz.set(<a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_bandwidth_hover_hz + (dt / (10.0f + dt)) * (get_weighted_noise_center_bandwidth_hz() - _bandwidth_hover_hz), 0, _fft_max_hz * 0.5f));</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>    _throttle_ref.set(<a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_throttle_ref + (dt / (10.0f + dt)) * (throttle_out * <a class="code hl_function" href="AP__Math_8h.html#a34f41fcf2bc527b1728ae04423dfba46">sq</a>((<span class="keywordtype">float</span>)_fft_min_hz.get() / _freq_hover_hz.get()) - _throttle_ref), 0.01f, 0.9f));</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span>}</div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span> </div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span><span class="comment">// save parameters as part of disarming</span></div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span><span class="keywordtype">void</span> AP_GyroFFT::save_params_on_disarm()</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>{</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>    }</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span> </div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>    _freq_hover_hz.save();</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>    _bandwidth_hover_hz.save();</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>    _throttle_ref.save();</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>}</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span> </div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>    <span class="comment">// notch tuning</span></div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span><span class="keywordtype">void</span> AP_GyroFFT::start_notch_tune()</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>{</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span>    }</div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span> </div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_start_average(_state)) {</div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: Unable to start FFT averaging&quot;</span>);</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>    }</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>    <span class="comment">// throttle averaging for average fft calculation</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>    _avg_throttle_out = 0.0f;</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span><span class="preprocessor">#if APM_BUILD_COPTER_OR_HELI || APM_BUILD_TYPE(APM_BUILD_ArduPlane)</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>    <a class="code hl_class" href="classAP__Motors.html">AP_Motors</a>* <a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> = <a class="code hl_function" href="namespaceAP.html#a304a59803176ebedc7e4a280c614075b">AP::motors</a>();</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> != <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>        _avg_throttle_out = <a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a>-&gt;<a class="code hl_function" href="classAP__Motors.html#a6641c5398dea1388547dff3db5d95a86">get_throttle_hover</a>();</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>    }</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>}</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span> </div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span><span class="comment">// calculate the frequency to be used for the harmonic notch</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span><span class="keywordtype">float</span> AP_GyroFFT::calculate_notch_frequency(<span class="keywordtype">float</span>* freqs, uint16_t numpeaks, <span class="keywordtype">float</span> harmonic_fit, uint8_t&amp; harmonics)</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>{</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>    <span class="keywordtype">float</span> harmonic = freqs[0];</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>    harmonics = 1;</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span> </div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>    <span class="keywordflow">for</span> (uint8_t i = 1; i &lt; numpeaks; i++) {</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>        <span class="keywordflow">if</span> (freqs[i] &lt; harmonic) {</div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>            <span class="keywordflow">for</span> (uint8_t <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a> = 2; <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a> &lt;=<a class="code hl_define" href="HarmonicNotchFilter_8h.html#af1151dca8cefec4b426ce895493bcbcf">HNF_MAX_HARMONICS</a>; <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>++) {</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>                <span class="keywordflow">if</span> (is_harmonic_of(harmonic, freqs[i], <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>, harmonic_fit)) {</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>                    harmonic = freqs[i];</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>                }</div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>            }</div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>        }</div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>    }</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>    <span class="comment">// select the harmonics that were matched</span></div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; numpeaks; i++) {</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>        <span class="keywordflow">for</span> (uint8_t <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a> = 1; <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a> &lt;=<a class="code hl_define" href="HarmonicNotchFilter_8h.html#af1151dca8cefec4b426ce895493bcbcf">HNF_MAX_HARMONICS</a>; <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>++) {</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>            <span class="keywordflow">if</span> (is_harmonic_of(freqs[i], harmonic, <a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>, harmonic_fit)) {</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>                harmonics |= 1&lt;&lt;(<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a> - 1);</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>            }</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>        }</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>    }</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>    <span class="keywordflow">return</span> harmonic;</div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>}</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span> </div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span><span class="keywordtype">void</span> AP_GyroFFT::stop_notch_tune()</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>{</div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>    }</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span> </div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>    <span class="keywordtype">float</span> freqs[FrequencyPeak::MAX_TRACKED_PEAKS] {};</div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span> </div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>    uint16_t numpeaks = <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_stop_average(_state, _config._fft_start_bin, _config._fft_end_bin, freqs);</div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span> </div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>    <span class="keywordflow">if</span> (numpeaks == 0) {</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>    }</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span> </div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>    uint8_t harmonics;</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>    <span class="keywordtype">float</span> harmonic = calculate_notch_frequency(freqs, numpeaks, _harmonic_fit, harmonics);</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span> </div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>    <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_INFO, <span class="stringliteral">&quot;FFT: Found peaks at %.1f/%.1f/%.1fHz&quot;</span>, freqs[0], freqs[1], freqs[2]);</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>    <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_NOTICE, <span class="stringliteral">&quot;FFT: Selected %.1fHz\n&quot;</span>, harmonic);</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span> </div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>    <span class="comment">// if we don&#39;t have a throttle value then all bets are off</span></div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(_avg_throttle_out) || <a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(harmonic)) {</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: Unable to calculate notch: need stable hover&quot;</span>);</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>        <a class="code hl_variable" href="classAP__Notify.html#a1025ca0850b8bf8e2560950352af842a">AP_Notify::events</a>.<a class="code hl_variable" href="structAP__Notify_1_1notify__events__type.html#a3bb4a95fb369e417b93e9dad80421f81">autotune_failed</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>    }</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span> </div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>    <span class="keywordflow">if</span> (!_ins-&gt;setup_throttle_gyro_harmonic_notch(harmonic, (<span class="keywordtype">float</span>)_fft_min_hz.get(), _avg_throttle_out, harmonics)) {</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: Unable to set throttle notch with %.1fHz/%.2f&quot;</span>,</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>            harmonic, _avg_throttle_out);</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>        <a class="code hl_variable" href="classAP__Notify.html#a1025ca0850b8bf8e2560950352af842a">AP_Notify::events</a>.<a class="code hl_variable" href="structAP__Notify_1_1notify__events__type.html#a3bb4a95fb369e417b93e9dad80421f81">autotune_failed</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>        <span class="comment">// save results to FFT slots</span></div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>        _throttle_ref.set(_avg_throttle_out);</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>        _freq_hover_hz.set(harmonic);</div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_NOTICE, <span class="stringliteral">&quot;FFT: Notch frequency %.1fHz and ref %.2f selected&quot;</span>, harmonic, _avg_throttle_out);</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>        <a class="code hl_variable" href="classAP__Notify.html#a1025ca0850b8bf8e2560950352af842a">AP_Notify::events</a>.<a class="code hl_variable" href="structAP__Notify_1_1notify__events__type.html#a851659a49a3bfcd26822f995577bd1b3">autotune_complete</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>    }</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>}</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span> </div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span><span class="comment">// return the noise peak that is being tracked</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>AP_GyroFFT::FrequencyPeak AP_GyroFFT::get_tracked_noise_peak()<span class="keyword"> const</span></div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>    <span class="comment">// if the user has specified a specific axis to track then use that</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>    <span class="keywordflow">if</span> (_harmonic_peak &gt; FrequencyPeak::MAX_TRACKED_PEAKS) {</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>        <span class="keywordflow">switch</span> (_harmonic_peak) {</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>        <span class="keywordflow">case</span> FFT_HARMONIC_FIT_TRACK_ROLL:</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>            <span class="keywordflow">if</span> (_global_state._harmonic_fit.x &lt; _harmonic_fit) {</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>                <span class="keywordflow">return</span> FrequencyPeak(_global_state._tracked_peak.x);</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>            }</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>        <span class="keywordflow">case</span> FFT_HARMONIC_FIT_TRACK_PITCH:</div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>            <span class="keywordflow">if</span> (_global_state._harmonic_fit.y &lt; _harmonic_fit) {</div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>                <span class="keywordflow">return</span> FrequencyPeak(_global_state._tracked_peak.y);</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>            }</div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>        <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>        }</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>        <span class="keywordflow">return</span> FrequencyPeak::CENTER;</div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>    }</div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>    <span class="comment">// if the user has specified a specific peak to track then use that</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>    <span class="keywordflow">if</span> (_harmonic_peak &gt; 0) {</div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>        <span class="keywordflow">return</span> FrequencyPeak(<a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(_harmonic_peak - 1, FrequencyPeak::CENTER, FrequencyPeak::UPPER_SHOULDER));</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>    }</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span> </div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>    <span class="comment">// required fit of 10% is fairly conservative when testing in SITL, testing shows that it&#39;s safer to</span></div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>    <span class="comment">// require both tracked axes to fit - biasing towards the highest energy peak</span></div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>    <span class="keywordflow">if</span> (_global_state._harmonic_fit.x &lt; _harmonic_fit &amp;&amp; _global_state._harmonic_fit.y &lt; _harmonic_fit) {</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>        <span class="keywordflow">return</span> FrequencyPeak(_global_state._tracked_peak.x);</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>    }</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span> </div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>    <span class="keywordflow">return</span> FrequencyPeak::CENTER;</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>}</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span> </div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span><span class="comment">// weighted center frequency</span></div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span><span class="keywordtype">float</span> AP_GyroFFT::get_weighted_freq_hz(FrequencyPeak peak)<span class="keyword"> const</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>    <span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; energy = get_center_freq_energy(peak);</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>    <span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; freq = get_noise_center_freq_hz(peak);</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span> </div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>    <span class="keywordflow">if</span> (!energy.<a class="code hl_function" href="classVector3.html#a3d258ebac882ccca247bb65def39ca87">is_nan</a>() &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>) &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>)) {</div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>        <span class="keywordflow">return</span> (freq.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> * energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + freq.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> * energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>) / (energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>        <span class="keywordflow">return</span> (freq.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + freq.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>) * 0.5f;</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>    }</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>}</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span> </div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span><span class="comment">// return an average center frequency weighted by bin energy</span></div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span><span class="keywordtype">float</span> AP_GyroFFT::get_weighted_noise_center_freq_hz()<span class="keyword"> const</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>        <span class="keywordflow">return</span> _fft_min_hz;</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>    }</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span> </div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>    <span class="keywordflow">if</span> (_health.is_zero()) {</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span><span class="preprocessor">#if APM_BUILD_COPTER_OR_HELI || APM_BUILD_TYPE(APM_BUILD_ArduPlane)</span></div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>        <span class="comment">// if we are post-filter sampling then throttle estimate will be useless</span></div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>        <span class="keywordflow">if</span> (using_post_filter_samples()) {</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>            <span class="keywordflow">return</span> 0.0f;</div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>        }</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>        <a class="code hl_class" href="classAP__Motors.html">AP_Motors</a>* <a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> = <a class="code hl_function" href="namespaceAP.html#a304a59803176ebedc7e4a280c614075b">AP::motors</a>();</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>        <span class="keywordflow">if</span> (<a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> != <span class="keyword">nullptr</span> &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(_throttle_ref)) {</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>            <span class="comment">// FFT is not healthy, fallback to FFT&#39;s throttle-based estimate</span></div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span>            <span class="keywordflow">return</span> <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_fft_min_hz * <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0f, sqrtf(<a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a>-&gt;<a class="code hl_function" href="classAP__Motors.html#a18a5b7f16341a421c9059b071da8cdf0">get_throttle_out</a>() / _throttle_ref)), _fft_min_hz, _fft_max_hz);</div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>        }</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>    }</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span> </div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span>    <span class="keyword">const</span> FrequencyPeak peak = get_tracked_noise_peak();</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>    <span class="comment">// pitch was good or required, roll was not, use pitch only</span></div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>    <span class="keywordflow">if</span> (!_health.x || _harmonic_peak == FFT_HARMONIC_FIT_TRACK_PITCH) {</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>        <span class="keywordflow">return</span> get_noise_center_freq_hz(peak).y;    <span class="comment">// Y-axis</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>    }</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>    <span class="comment">// roll was good or required, pitch was not, use roll only</span></div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>    <span class="keywordflow">if</span> (!_health.y || _harmonic_peak == FFT_HARMONIC_FIT_TRACK_ROLL) {</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>        <span class="keywordflow">return</span> get_noise_center_freq_hz(peak).x;    <span class="comment">// X-axis</span></div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>    }</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span> </div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>    <span class="keywordflow">return</span> get_weighted_freq_hz(peak);</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>}</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span> </div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span><span class="comment">// return all the center frequencies weighted by bin energy</span></div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>uint8_t AP_GyroFFT::get_weighted_noise_center_frequencies_hz(uint8_t num_freqs, <span class="keywordtype">float</span>* freqs)<span class="keyword"> const</span></div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>        freqs[0] = _fft_min_hz;</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>    }</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span> </div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span>    <span class="keywordflow">if</span> (_health.is_zero()) {</div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span><span class="preprocessor">#if APM_BUILD_COPTER_OR_HELI || APM_BUILD_TYPE(APM_BUILD_ArduPlane)</span></div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>        <span class="comment">// if we are post-filter sampling then throttle estimate will be useless</span></div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>        <span class="keywordflow">if</span> (using_post_filter_samples()) {</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>        }</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>        <a class="code hl_class" href="classAP__Motors.html">AP_Motors</a>* <a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> = <a class="code hl_function" href="namespaceAP.html#a304a59803176ebedc7e4a280c614075b">AP::motors</a>();</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>        <span class="keywordflow">if</span> (<a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a> != <span class="keyword">nullptr</span>) {</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>            <span class="comment">// FFT is not healthy, fallback to FFT&#39;s throttle-based estimate</span></div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>            freqs[0] = <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(_fft_min_hz * <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0f, sqrtf(<a class="code hl_variable" href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a>-&gt;<a class="code hl_function" href="classAP__Motors.html#a18a5b7f16341a421c9059b071da8cdf0">get_throttle_out</a>() / _throttle_ref)), _fft_min_hz, _fft_max_hz);</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>            <span class="keywordflow">return</span> 1;</div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>        }</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>    }</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span> </div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>    <span class="comment">// pitch was good or required, roll was not, use pitch only</span></div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>    <span class="keywordflow">if</span> (!_health.x || _harmonic_peak == FFT_HARMONIC_FIT_TRACK_PITCH) {</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>        <span class="keyword">const</span> uint8_t tracked_peaks = <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(_health.y, num_freqs);</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>        <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; tracked_peaks; i++) {</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>            freqs[i] = get_noise_center_freq_hz(FrequencyPeak(i)).y;    <span class="comment">// Y-axis</span></div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>        }</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>        <span class="keywordflow">return</span> tracked_peaks;</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>    }</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>    <span class="comment">// roll was good or required, pitch was not, use roll only</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>    <span class="keywordflow">if</span> (!_health.y || _harmonic_peak == FFT_HARMONIC_FIT_TRACK_ROLL) {</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>        <span class="keyword">const</span> uint8_t tracked_peaks = <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(_health.x, num_freqs);</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>        <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; tracked_peaks; i++) {</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>            freqs[i] = get_noise_center_freq_hz(FrequencyPeak(i)).x;    <span class="comment">// X-axis</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>        }</div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>        <span class="keywordflow">return</span> tracked_peaks;</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>    }</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span> </div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>    <span class="keyword">const</span> uint8_t tracked_peaks = <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(_health.x, _health.y), num_freqs);</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; tracked_peaks; i++) {</div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>        freqs[i] = get_weighted_freq_hz(FrequencyPeak(i));</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>    }</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>    <span class="keywordflow">return</span> tracked_peaks;</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>}</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span> </div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span><span class="comment">// return noise energy at the requested frequency</span></div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="keywordtype">float</span> AP_GyroFFT::has_noise_at_frequency_hz(<span class="keywordtype">float</span> freq)<span class="keyword"> const</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span>        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>    }</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span> </div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>    <span class="keywordtype">float</span> max_energy = 0.0f;</div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span> </div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>    <span class="comment">// check each axis of each peak to see if it contains the pass frequency</span></div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; _tracked_peaks; i++) {</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>        <span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; <a class="code hl_function" href="Derivative_8cpp.html#a430ab649ea04b609ea794c746bfee4ba">noise</a> = get_noise_center_freq_hz(FrequencyPeak(i));</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>        <span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; snr = get_noise_signal_to_noise_db(FrequencyPeak(i));</div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span> </div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>        <span class="keywordflow">for</span> (uint8_t j = 0; j &lt; <a class="code hl_define" href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a>; j++) {</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>            <span class="keywordflow">if</span> (!_rpy_health[j]) {</div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>                <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>            }</div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span> </div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>            <span class="comment">// only check one bin either side of the frequency</span></div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>            <span class="keywordflow">if</span> ((<a class="code hl_function" href="Derivative_8cpp.html#a430ab649ea04b609ea794c746bfee4ba">noise</a>[j] - _state-&gt;_bin_resolution) &lt; freq &amp;&amp; (<a class="code hl_function" href="Derivative_8cpp.html#a430ab649ea04b609ea794c746bfee4ba">noise</a>[j] + _state-&gt;_bin_resolution) &gt; freq) {</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>                max_energy = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(snr[j], max_energy);</div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>            }</div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>        }</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>    }</div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>    <span class="keywordflow">return</span> max_energy;</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>}</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span> </div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span><span class="keywordtype">float</span> AP_GyroFFT::calculate_weighted_freq_hz(<span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; energy, <span class="keyword">const</span> <a class="code hl_class" href="classVector3.html">Vector3f</a>&amp; freq)<span class="keyword"> const</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span><span class="keyword"></span>{</div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>    <span class="comment">// there is generally a lot of high-energy, slightly lower frequency noise on yaw, however this</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span>    <span class="comment">// appears to be a second-order effect as only targetting pitch and roll (x &amp; y) produces much cleaner output all round</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>    <span class="keywordflow">if</span> (!energy.<a class="code hl_function" href="classVector3.html#a3d258ebac882ccca247bb65def39ca87">is_nan</a>() &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a>) &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>)) {</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>        <span class="keywordflow">return</span> (freq.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> * energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + freq.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a> * energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>)</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>            / (energy.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + energy.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>);</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>    }</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>    <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span>        <span class="keywordflow">return</span> (freq.<a class="code hl_variable" href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">x</a> + freq.<a class="code hl_variable" href="classVector3.html#a561df88b28e106e337a25bb86554a569">y</a>) * 0.5f;</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>    }</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span>}</div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span> </div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span><span class="comment">// @LoggerMessage: FTN1</span></div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span><span class="comment">// @Description: FFT Filter Tuning</span></div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span><span class="comment">// @Field: TimeUS: microseconds since system startup</span></div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span><span class="comment">// @Field: PkAvg: peak noise frequency as an energy-weighted average of roll and pitch peak frequencies</span></div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span><span class="comment">// @Field: BwAvg: bandwidth of weighted peak frequency where edges are determined by FFT_ATT_REF</span></div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span><span class="comment">// @Field: SnX: signal-to-noise ratio on the roll axis</span></div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span><span class="comment">// @Field: SnY: signal-to-noise ratio on the pitch axis</span></div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span><span class="comment">// @Field: SnZ: signal-to-noise ratio on the yaw axis</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span><span class="comment">// @Field: FtX: harmonic fit on roll of the highest noise peak to the second highest noise peak</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span><span class="comment">// @Field: FtY: harmonic fit on pitch of the highest noise peak to the second highest noise peak</span></div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span><span class="comment">// @Field: FtZ: harmonic fit on yaw of the highest noise peak to the second highest noise peak</span></div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span><span class="comment">// @Field: FHX: FFT health, X-axis</span></div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span><span class="comment">// @Field: FHY: FFT health, Y-axis</span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span><span class="comment">// @Field: FHZ: FFT health, Z-axis</span></div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span><span class="comment">// @Field: Tc: FFT cycle time</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span> </div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span><span class="preprocessor">#if HAL_LOGGING_ENABLED</span></div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span> </div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span><span class="comment">// log gyro fft messages</span></div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span><span class="keywordtype">void</span> AP_GyroFFT::write_log_messages()</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>{</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>    }</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span> </div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>    <a class="code hl_function" href="namespaceAP.html#aa35bfac1ea2da16f110e8e72db7b3b20">AP::logger</a>().<a class="code hl_function" href="classAP__Logger.html#abab7cb26825a8dfb1e5e92cf7fcf4152">WriteStreaming</a>(</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>        <span class="stringliteral">&quot;FTN1&quot;</span>,</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>        <span class="stringliteral">&quot;TimeUS,PkAvg,BwAvg,SnX,SnY,SnZ,FtX,FtY,FtZ,FHX,FHY,FHZ,Tc&quot;</span>,</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>        <span class="stringliteral">&quot;szz---%%%---s&quot;</span>,</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>        <span class="stringliteral">&quot;F-----------F&quot;</span>,</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>        <span class="stringliteral">&quot;QffffffffBBBI&quot;</span>,</div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a7aa0ce7625c9680e30ff4a99940907a5">AP_HAL::micros64</a>(),</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span>        get_weighted_noise_center_freq_hz(),</div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>        get_weighted_noise_center_bandwidth_hz(),</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>        get_noise_signal_to_noise_db().<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>        get_noise_signal_to_noise_db().y,</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>        get_noise_signal_to_noise_db().z,</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>        get_raw_noise_harmonic_fit().<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>        get_raw_noise_harmonic_fit().y,</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>        get_raw_noise_harmonic_fit().z,</div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span>        _health.x, _health.y, _health.z, _output_cycle_micros);</div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span> </div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>    log_noise_peak(0, FrequencyPeak::CENTER);</div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>    <span class="keywordflow">if</span> (_tracked_peaks&gt; 1) {</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>        log_noise_peak(1, FrequencyPeak::LOWER_SHOULDER);</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>        log_noise_peak(2, FrequencyPeak::UPPER_SHOULDER);</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>    }</div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span> </div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span><span class="preprocessor">#if DEBUG_FFT</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>    <span class="keyword">const</span> uint32_t now = <a class="code hl_function" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>    <span class="comment">// output at 1hz</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>    <span class="keywordflow">if</span> ((now - _last_output_ms) &gt; 1000) {</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>        <span class="comment">// doing this from the update thread overflows the stack</span></div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>        <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: f:%.1f, fr:%.1f, b:%u, fd:%.1f&quot;</span>,</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>                        _debug_state._center_freq_hz_filtered[FrequencyPeak::CENTER][_update_axis], _debug_state._center_freq_hz[_update_axis], _debug_max_bin, _debug_max_bin_freq);</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: bw:%.1f, e:%.1f, r:%.1f, snr:%.1f&quot;</span>,</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>                        _debug_state._center_bandwidth_hz_filtered[FrequencyPeak::CENTER][_update_axis], _debug_max_freq_bin, _ref_energy[_debug_max_bin][_update_axis], _debug_snr);</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>        _last_output_ms = now;</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>    }</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>}</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span> </div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span><span class="comment">// @LoggerMessage: FTN2</span></div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span><span class="comment">// @Description: FFT Noise Frequency Peak</span></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span><span class="comment">// @Field: TimeUS: microseconds since system startup</span></div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span><span class="comment">// @Field: Id: peak id where 0 is the centre peak, 1 is the lower shoulder and 2 is the upper shoulder</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span><span class="comment">// @Field: PkX: noise frequency of the peak on roll</span></div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span><span class="comment">// @Field: PkY: noise frequency of the peak on pitch</span></div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span><span class="comment">// @Field: PkZ: noise frequency of the peak on yaw</span></div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span><span class="comment">// @Field: BwX: bandwidth of the peak frequency on roll where edges are determined by FFT_ATT_REF</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span><span class="comment">// @Field: BwY: bandwidth of the peak frequency on pitch where edges are determined by FFT_ATT_REF</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span><span class="comment">// @Field: BwZ: bandwidth of the peak frequency on yaw where edges are determined by FFT_ATT_REF</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span><span class="comment">// @Field: SnX: signal-to-noise ratio on the roll axis</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span><span class="comment">// @Field: SnY: signal-to-noise ratio on the pitch axis</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span><span class="comment">// @Field: SnZ: signal-to-noise ratio on the yaw axis</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span><span class="comment">// @Field: EnX: power spectral density bin energy of the peak on roll</span></div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span><span class="comment">// @Field: EnY: power spectral density bin energy of the peak on roll</span></div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span><span class="comment">// @Field: EnZ: power spectral density bin energy of the peak on roll</span></div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span> </div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span><span class="comment">// write a single log message</span></div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span><span class="keywordtype">void</span> AP_GyroFFT::log_noise_peak(uint8_t <span class="keywordtype">id</span>, FrequencyPeak peak)<span class="keyword"> const</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span><span class="keyword"></span>{</div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>    <a class="code hl_function" href="namespaceAP.html#aa35bfac1ea2da16f110e8e72db7b3b20">AP::logger</a>().<a class="code hl_function" href="classAP__Logger.html#abab7cb26825a8dfb1e5e92cf7fcf4152">WriteStreaming</a>(<span class="stringliteral">&quot;FTN2&quot;</span>, <span class="stringliteral">&quot;TimeUS,Id,PkX,PkY,PkZ,BwX,BwY,BwZ,SnX,SnY,SnZ,EnX,EnY,EnZ&quot;</span>, <span class="stringliteral">&quot;s#zzzzzz------&quot;</span>, <span class="stringliteral">&quot;F-------------&quot;</span>, <span class="stringliteral">&quot;QBffffffffffff&quot;</span>,</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>        <a class="code hl_function" href="namespaceAP__HAL.html#a7aa0ce7625c9680e30ff4a99940907a5">AP_HAL::micros64</a>(),</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>        <span class="keywordtype">id</span>,</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>        get_noise_center_freq_hz(peak).<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>        get_noise_center_freq_hz(peak).y,</div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>        get_noise_center_freq_hz(peak).z,</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>        get_noise_center_bandwidth_hz(peak).<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>        get_noise_center_bandwidth_hz(peak).y,</div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>        get_noise_center_bandwidth_hz(peak).z,</div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>        get_noise_signal_to_noise_db(peak).<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>        get_noise_signal_to_noise_db(peak).y,</div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>        get_noise_signal_to_noise_db(peak).z,</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>        get_center_freq_energy(peak).<a class="code hl_define" href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a>,</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>        get_center_freq_energy(peak).y,</div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>        get_center_freq_energy(peak).z);</div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>}</div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span> </div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span> </div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span><span class="comment">// return an average noise bandwidth weighted by bin energy</span></div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span><span class="keywordtype">float</span> AP_GyroFFT::get_weighted_noise_center_bandwidth_hz()<span class="keyword"> const</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span><span class="keyword"></span>{</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>    <span class="keywordflow">if</span> (!analysis_enabled()) {</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span>        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>    }</div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span> </div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>    <span class="keyword">const</span> FrequencyPeak peak = get_tracked_noise_peak();</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span> </div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>    <span class="keywordflow">return</span> calculate_weighted_freq_hz(get_center_freq_energy(peak), get_noise_center_bandwidth_hz(peak));</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>}</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span> </div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span><span class="comment">// calculate noise frequencies from FFT data provided by the HAL subsystem</span></div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span><span class="comment">// called from FFT thread</span></div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span><span class="keywordtype">void</span> AP_GyroFFT::calculate_noise(<span class="keywordtype">bool</span> calibrating, <span class="keyword">const</span> EngineConfig&amp; config)</div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>{</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>    <span class="comment">// calculate the SNR and center frequency energy</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>    <span class="keywordtype">float</span> weighted_center_freq_hz = 0.0f;</div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span> </div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>    uint8_t num_peaks = calculate_tracking_peaks(weighted_center_freq_hz, calibrating, config);</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span> </div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>    _thread_state._center_freq_bin[_update_axis] = _state-&gt;_peak_data[_thread_state._center_peak[_update_axis]]._bin;</div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>    _thread_state._center_freq_hz[_update_axis] = weighted_center_freq_hz;</div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>    <span class="comment">// record the last time we had a good signal on this axis</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>    <span class="keywordflow">if</span> (num_peaks &gt; 0) {</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span>        _thread_state._health_ms[_update_axis] = <a class="code hl_function" href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a>();</div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>        _thread_state._health_ms[_update_axis] = 0;</div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>    }</div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>    _thread_state._health[_update_axis] = num_peaks;</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>    FrequencyPeak tracked_peak = FrequencyPeak::CENTER;</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span> </div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>    <span class="comment">// record the tracked peak for harmonic fit, but only if we have more than one noise peak</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>    <span class="comment">// this checks filtered energies and so can allow energies to be closer together</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>    <span class="keywordflow">if</span> (num_peaks &gt; 1 &amp;&amp; _tracked_peaks &gt; 1 &amp;&amp; !<a class="code hl_function" href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a>(get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis))) {</div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>        <span class="keywordflow">if</span> (get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis) &gt; get_tl_noise_center_freq_hz(FrequencyPeak::LOWER_SHOULDER, _update_axis)</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>            <span class="comment">// ignore the fit if there is too big a discrepancy between the energies</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>            &amp;&amp; get_tl_center_freq_energy(FrequencyPeak::CENTER, _update_axis) &lt; get_tl_center_freq_energy(FrequencyPeak::LOWER_SHOULDER, _update_axis) * FFT_HARMONIC_FIT_MULT) {</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>            tracked_peak = FrequencyPeak::LOWER_SHOULDER;</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num_peaks &gt; 2 &amp;&amp; get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis) &gt; get_tl_noise_center_freq_hz(FrequencyPeak::UPPER_SHOULDER, _update_axis)</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>            <span class="comment">// ignore the fit if there is too big a discrepancy between the energies</span></div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>            &amp;&amp; get_tl_center_freq_energy(FrequencyPeak::CENTER, _update_axis) &lt; get_tl_center_freq_energy(FrequencyPeak::UPPER_SHOULDER, _update_axis) * FFT_HARMONIC_FIT_MULT) {</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>            tracked_peak = FrequencyPeak::UPPER_SHOULDER;</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>        }</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>    }</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span> </div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>    _thread_state._tracked_peak[_update_axis] = tracked_peak;</div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span> </div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>    <span class="comment">// if targetting more than one harmonic then make sure we get the fundamental</span></div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>    <span class="comment">// on larger copters the second harmonic often has more energy</span></div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>    <span class="comment">// if the highest peak is above the second highest then check for harmonic fit</span></div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>    <span class="comment">// comparisons are made using filter, normalised data</span></div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>    <span class="keywordflow">if</span> (_thread_state._tracked_peak[_update_axis] != FrequencyPeak::CENTER) {</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>        <span class="comment">// calculate the fit and filter at 10hz</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>        <span class="keyword">const</span> <span class="keywordtype">float</span> harmonic_fit = 100.0f * fabsf(get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis)</div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>            - get_tl_noise_center_freq_hz(tracked_peak, _update_axis) * _harmonic_multiplier)</div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>            / get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis);</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span> </div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span>        <span class="comment">// calculate the fit and filter at 10hz</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>        <span class="keywordflow">if</span> (isfinite(harmonic_fit)) {</div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>            _thread_state._harmonic_fit[_update_axis] = _harmonic_fit_filter[_update_axis].apply(harmonic_fit);</div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span>        }</div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span>        _thread_state._harmonic_fit[_update_axis] = 100.0f;</div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>    }</div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span><span class="preprocessor">#if DEBUG_FFT</span></div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span>    <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>    _debug_state = _thread_state;</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>    _debug_max_freq_bin = _state-&gt;get_freq_bin(_state-&gt;_peak_data[FrequencyPeak::CENTER]._bin);</div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>    _debug_max_bin_freq = _state-&gt;_peak_data[FrequencyPeak::CENTER]._freq_hz;</div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span>    _debug_snr = snr;</div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>    _debug_max_bin = _state-&gt;_peak_data[FrequencyPeak::CENTER]._bin;</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>}</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span> </div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span> </div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="comment">// calculate noise peaks based on the frequencies closest to the recent historical average, switching peaks around as necessary</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>uint8_t AP_GyroFFT::calculate_tracking_peaks(<span class="keywordtype">float</span>&amp; weighted_center_freq_hz, <span class="keywordtype">bool</span> calibrating, <span class="keyword">const</span> EngineConfig&amp; config)</div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>{</div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span>    uint8_t num_peaks = 0;</div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>    FrequencyData freqs(*<span class="keyword">this</span>, config);</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span> </div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>    <span class="comment">// the noise peaks are returned by the HAL in decreasing order of magnitude, however each peak can temporarily</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span>    <span class="comment">// switch places with another depending on a whole host of hardware and software factors</span></div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>    <span class="comment">// thus we must be able to temporarily reassign the peaks so that the filtered values track</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>    <span class="comment">// a continuous frequency</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span>    DistanceMatrix distance_matrix;</div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span>    find_distance_matrix(distance_matrix, freqs, config);</div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span> </div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span>    FrequencyPeak center = find_closest_peak(FrequencyPeak::CENTER, distance_matrix);</div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span>    FrequencyPeak lower = find_closest_peak(FrequencyPeak::LOWER_SHOULDER, distance_matrix, 1 &lt;&lt; center);</div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span>    FrequencyPeak upper = find_closest_peak(FrequencyPeak::UPPER_SHOULDER, distance_matrix, 1 &lt;&lt; center | 1 &lt;&lt; lower);</div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span> </div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span>    <span class="comment">// if we have had the maximum number of swapped cycles, force a full calculation</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>    <span class="keywordflow">if</span> (calibrating || _distorted_cycles[_update_axis] == 0) {</div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span>        num_peaks = calculate_tracking_peaks(weighted_center_freq_hz, freqs, config);</div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span><span class="preprocessor">#if DEBUG_FFT</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>        <a class="code hl_function" href="stdio_8h.html#a55f3d956bb2ba20b5059e9e25484a47f">printf</a>(<span class="stringliteral">&quot;Skipped update, order would have been is %d/%.1f(%.1f) %d/%.1f(%.1f) %d/%.1f(%.1f) n = %d\n&quot;</span>,</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span>            center, _state-&gt;_peak_data[center]._freq_hz, get_tl_noise_center_freq_hz(FrequencyPeak::CENTER, _update_axis),</div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>            lower, _state-&gt;_peak_data[lower]._freq_hz, get_tl_noise_center_freq_hz(FrequencyPeak::LOWER_SHOULDER, _update_axis),</div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>            upper, _state-&gt;_peak_data[upper]._freq_hz, get_tl_noise_center_freq_hz(FrequencyPeak::UPPER_SHOULDER, _update_axis), num_peaks);</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>        <span class="keywordflow">return</span> num_peaks;</div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span>    }</div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span> </div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span>    <span class="comment">// another peak is closer to what is currently considered the center frequency</span></div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>    <span class="keywordflow">if</span> (center != FrequencyPeak::CENTER || lower != FrequencyPeak::LOWER_SHOULDER || upper != FrequencyPeak::UPPER_SHOULDER) {</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>        <span class="keywordflow">if</span> (lower != FrequencyPeak::NONE &amp;&amp; calculate_filtered_noise(FrequencyPeak::LOWER_SHOULDER, lower, freqs, config)) {</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>            num_peaks++;</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span>            lower = FrequencyPeak::NONE;</div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>        }</div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span>        <span class="keywordflow">if</span> (upper != FrequencyPeak::NONE &amp;&amp; calculate_filtered_noise(FrequencyPeak::UPPER_SHOULDER, upper, freqs, config)) {</div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>            num_peaks++;</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>            upper = FrequencyPeak::NONE;</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span>        }</div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span>        <span class="keywordflow">if</span> (center != FrequencyPeak::NONE &amp;&amp; calculate_filtered_noise(FrequencyPeak::CENTER,  center, freqs, config)) {</div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span>            num_peaks++;</div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>            center = FrequencyPeak::NONE;</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>        }</div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>        weighted_center_freq_hz = freqs.get_weighted_frequency(center);</div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>        _thread_state._center_peak[_update_axis] = center;</div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>        update_snr_values(freqs);</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>        <span class="comment">// if two adjacent peaks have simply swapped, we will allow this to continue indefinitely</span></div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>        <span class="comment">// as there is no loss of fidelity</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>        <span class="keywordflow">if</span> (!((center == FrequencyPeak::LOWER_SHOULDER &amp;&amp; lower == FrequencyPeak::CENTER)</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>            || (center == FrequencyPeak::UPPER_SHOULDER &amp;&amp; upper == FrequencyPeak::CENTER))) {</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>            _distorted_cycles[_update_axis]--;</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>        }</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>        <span class="keywordflow">return</span> num_peaks;</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>    }</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span> </div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>    num_peaks = calculate_tracking_peaks(weighted_center_freq_hz, freqs, config);</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span> </div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>    <span class="keywordflow">return</span> num_peaks;</div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>}</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span> </div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span><span class="comment">// calculate the noise and whether valid for each peak</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>uint8_t AP_GyroFFT::calculate_tracking_peaks(<span class="keywordtype">float</span>&amp; weighted_center_freq_hz, <span class="keyword">const</span> FrequencyData&amp; freqs, <span class="keyword">const</span> EngineConfig&amp; config)</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span>{</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>    uint8_t num_peaks = 0;</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>    <span class="keywordflow">if</span> (calculate_filtered_noise(FrequencyPeak::LOWER_SHOULDER, FrequencyPeak::LOWER_SHOULDER, freqs, config)) {</div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>        num_peaks++;</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>    }</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>    <span class="keywordflow">if</span> (calculate_filtered_noise(FrequencyPeak::UPPER_SHOULDER, FrequencyPeak::UPPER_SHOULDER, freqs, config)) {</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>        num_peaks++;</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span>    }</div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>    <span class="keywordflow">if</span> (calculate_filtered_noise(FrequencyPeak::CENTER, FrequencyPeak::CENTER, freqs, config)) {</div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>        num_peaks++;</div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span>    }</div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>    <span class="comment">// record the number of cycles where something was tracked</span></div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>    _distorted_cycles[_update_axis] = <a class="code hl_function" href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a>(_distorted_cycles[_update_axis] + 1, 0, <a class="code hl_define" href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a>);</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>    weighted_center_freq_hz = freqs.get_weighted_frequency(FrequencyPeak::CENTER);</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>    _thread_state._center_peak[_update_axis] = FrequencyPeak::CENTER;</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span> </div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>    update_snr_values(freqs);</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span> </div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>    <span class="keywordflow">return</span> num_peaks;</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>}</div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span> </div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span><span class="comment">// calculate noise frequencies from FFT data provided by the HAL subsystem</span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="comment">// target_peak is the filtered record we want to apply the new fft data to, source peak is where the fft data is coming from</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="comment">// called from FFT thread</span></div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span><span class="keywordtype">bool</span> AP_GyroFFT::calculate_filtered_noise(FrequencyPeak target_peak, FrequencyPeak source_peak, <span class="keyword">const</span> FrequencyData&amp; freqs, <span class="keyword">const</span> EngineConfig&amp; config)</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span>{</div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>    <span class="keywordflow">if</span> (source_peak &gt; FrequencyPeak::MAX_TRACKED_PEAKS) {</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>        <span class="comment">// if we failed to find a signal, carry on using the previous readings</span></div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>        <span class="keywordflow">if</span> (_missed_cycles[_update_axis][target_peak]++ &lt; <a class="code hl_define" href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a>) {</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span>            <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// the peak is synthetic</span></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>        }</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>        update_tl_center_freq_energy(target_peak, _update_axis, 0.0f);</div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>        update_tl_noise_center_bandwidth_hz(target_peak, _update_axis, _bandwidth_hover_hz);</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>        update_tl_noise_center_freq_hz(target_peak, _update_axis, config._fft_min_hz);</div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span>    }</div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span> </div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>    AP_HAL::DSP::FrequencyPeakData* peak_data = &amp;_state-&gt;_peak_data[source_peak];</div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span> </div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>    <span class="keyword">const</span> uint16_t nb = peak_data-&gt;_bin;</div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span> </div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>    <span class="keywordflow">if</span> (freqs.is_valid(FrequencyPeak(source_peak))) {</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>        <span class="comment">// total peak energy requires an integration, as an approximation use amplitude * noise width * 5/6</span></div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>        update_tl_center_freq_energy(target_peak, _update_axis, _state-&gt;get_freq_bin(nb) * peak_data-&gt;_noise_width_hz * 0.8333f);</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span>        update_tl_noise_center_bandwidth_hz(target_peak, _update_axis, peak_data-&gt;_noise_width_hz);</div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>        update_tl_noise_center_freq_hz(target_peak, _update_axis, freqs.get_weighted_frequency(FrequencyPeak(source_peak)));</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>        _missed_cycles[_update_axis][target_peak] = 0;</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>    }</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span> </div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>    <span class="comment">// if we failed to find a signal, carry on using the previous readings</span></div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>    <span class="keywordflow">if</span> (_missed_cycles[_update_axis][target_peak]++ &lt; <a class="code hl_define" href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a>) {</div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// the peak is synthetic</span></div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>    }</div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span> </div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>    <span class="comment">// we failed to find a signal for more than FFT_MAX_MISSED_UPDATES cycles</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>    update_tl_center_freq_energy(target_peak, _update_axis, _state-&gt;get_freq_bin(nb) * peak_data-&gt;_noise_width_hz * 0.8333f);     <span class="comment">// use the actual energy detected rather than 0</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>    update_tl_noise_center_bandwidth_hz(target_peak, _update_axis, _bandwidth_hover_hz);</div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>    update_tl_noise_center_freq_hz(target_peak, _update_axis, config._fft_min_hz);</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span> </div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>}</div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span> </div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span><span class="keywordtype">void</span> AP_GyroFFT::update_snr_values(<span class="keyword">const</span> FrequencyData&amp; freqs)</div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>{</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>    _thread_state._center_freq_snr[FrequencyPeak::CENTER][_update_axis] = freqs.get_signal_to_noise(FrequencyPeak::CENTER);</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>    _thread_state._center_freq_snr[FrequencyPeak::LOWER_SHOULDER][_update_axis] = freqs.get_signal_to_noise(FrequencyPeak::LOWER_SHOULDER);</div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>    _thread_state._center_freq_snr[FrequencyPeak::UPPER_SHOULDER][_update_axis] = freqs.get_signal_to_noise(FrequencyPeak::UPPER_SHOULDER);</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>}</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span> </div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span> </div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span><span class="comment">// filter values through a median sliding window followed by low pass filter</span></div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span><span class="comment">// this eliminates temporary spikes in the detected frequency that are either pure noise</span></div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span><span class="comment">// or a different peak that will erroneously bias the peak we are tracking</span></div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span><span class="keywordtype">float</span> AP_GyroFFT::MedianLowPassFilter3dFloat::apply(uint8_t axis, <span class="keywordtype">float</span> sample)</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>{</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>    _median_filter[axis].apply(sample);</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> a = _median_filter[axis].get_sample(0);</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> b = _median_filter[axis].get_sample(1);</div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> c = _median_filter[axis].get_sample(2);</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>    <span class="keywordtype">float</span> median = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(<a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(a, b), <a class="code hl_define" href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(a, b), c));</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>    <span class="keywordflow">return</span> _lowpass_filter[axis].apply(median);</div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>}</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span> </div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span><span class="comment">// initialize a FrequencyData structure with peak frequency information for use in the swapping algorithm</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>AP_GyroFFT::FrequencyData::FrequencyData(<span class="keyword">const</span> AP_GyroFFT&amp; gyrofft, <span class="keyword">const</span> EngineConfig&amp; config)</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>{</div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; FrequencyPeak::MAX_TRACKED_PEAKS; i++) {</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>        valid[i] = gyrofft.get_weighted_frequency(FrequencyPeak(i), frequency[i], snr[i], config);</div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>    }</div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>}</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span> </div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span><span class="comment">// calculate noise frequencies from FFT data provided by the HAL subsystem</span></div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span><span class="keywordtype">bool</span> AP_GyroFFT::get_weighted_frequency(FrequencyPeak peak, <span class="keywordtype">float</span>&amp; weighted_peak_freq_hz, <span class="keywordtype">float</span>&amp; snr, <span class="keyword">const</span> EngineConfig&amp; config)<span class="keyword"> const</span></div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span><span class="keyword"></span>{</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>    AP_HAL::DSP::FrequencyPeakData* peak_data = &amp;_state-&gt;_peak_data[peak];</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span> </div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>    <span class="keyword">const</span> uint16_t bin = peak_data-&gt;_bin;</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span> </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>    <span class="comment">// calculate the SNR and center frequency energy</span></div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> max_energy = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0f, _state-&gt;get_freq_bin(bin));</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span>    <span class="keyword">const</span> <span class="keywordtype">float</span> ref_energy = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(1.0f, _ref_energy[bin][_update_axis]);</div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>    snr = 10.f * (log10f(max_energy) - log10f(ref_energy));</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span> </div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>    <span class="comment">// if the bin energy is above the noise threshold then we have a signal</span></div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>    <span class="keywordflow">if</span> (!_thread_state._noise_needs_calibration &amp;&amp; isfinite(_state-&gt;get_freq_bin(bin)) &amp;&amp; snr &gt; config._snr_threshold_db) {</div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>        weighted_peak_freq_hz = <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(peak_data-&gt;_freq_hz, (<span class="keywordtype">float</span>)config._fft_min_hz, (<span class="keywordtype">float</span>)config._fft_max_hz);</div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>    }</div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span> </div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span>    weighted_peak_freq_hz = (float)config._fft_min_hz;</div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span> </div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>}</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span> </div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span><span class="comment">// calculate a matrix of distances between the current filtered estimates and instantaneous values from the current cycle</span></div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span><span class="keywordtype">void</span> AP_GyroFFT::find_distance_matrix(DistanceMatrix&amp; distance_matrix, <span class="keyword">const</span> FrequencyData&amp; freqs, <span class="keyword">const</span> EngineConfig&amp; config)<span class="keyword"> const</span></div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span><span class="keyword"></span>{</div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>    <span class="keywordtype">float</span> curr_freqs[FrequencyPeak::MAX_TRACKED_PEAKS];</div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>    <span class="comment">// get the current frequency estimate for all peaks</span></div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; FrequencyPeak::MAX_TRACKED_PEAKS; i++) {</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>        curr_freqs[i] = get_tl_noise_center_freq_hz(FrequencyPeak(i), _update_axis);</div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>    }</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>    <span class="comment">// calculate the matrix</span></div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; FrequencyPeak::MAX_TRACKED_PEAKS; i++) {</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>        <span class="keywordflow">for</span> (uint8_t j = 0; j &lt; FrequencyPeak::MAX_TRACKED_PEAKS; j++) {</div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>            distance_matrix[i][j] = fabsf((freqs.is_valid(FrequencyPeak(i)) ?</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>                freqs.get_weighted_frequency(FrequencyPeak(i)) : FLT_MAX) - curr_freqs[j]);</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>        }</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>    }</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>}</div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span> </div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span><span class="comment">// return the instantaneous peak that is closest to the target estimate peak</span></div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span>AP_GyroFFT::FrequencyPeak AP_GyroFFT::find_closest_peak(<span class="keyword">const</span> FrequencyPeak target, <span class="keyword">const</span> DistanceMatrix&amp; distance_matrix, uint8_t ignore)<span class="keyword"> const</span></div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span><span class="keyword"></span>{</div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span>    <span class="comment">// find the closest peak to target</span></div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>    uint8_t closest = target;</div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span>    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; FrequencyPeak::MAX_TRACKED_PEAKS; i++) {</div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>        <span class="keywordflow">if</span> (distance_matrix[i][target] &lt; distance_matrix[closest][target] &amp;&amp; (1 &lt;&lt; i &amp; ~ignore)) {</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>            closest = i;</div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>        }</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>    }</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>    <span class="comment">// didn&#39;t find anything</span></div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>    <span class="keywordflow">if</span> (!(1&lt;&lt;closest &amp; ~ignore)) {</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>        <span class="keywordflow">return</span> FrequencyPeak::NONE;</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>    }</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>    <span class="keywordflow">return</span> FrequencyPeak(closest);</div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>}</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span> </div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span><span class="comment">// calculate noise baseline from FFT data provided by the HAL subsystem</span></div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span><span class="comment">// called from FFT thread</span></div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span><span class="keywordtype">void</span> AP_GyroFFT::update_ref_energy(uint16_t max_bin)</div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>{</div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>    <span class="keywordflow">if</span> (!_thread_state._noise_needs_calibration) {</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>    }</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span> </div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>    <span class="comment">// according to https://www.tcd.ie/Physics/research/groups/magnetism/files/lectures/py5021/MagneticSensors3.pdf sensor noise is not necessarily gaussian</span></div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>    <span class="comment">// determine a PS noise reference at each of the possible center frequencies</span></div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>    <span class="keywordflow">if</span> (_noise_cycles == 0 &amp;&amp; _noise_calibration_cycles[_update_axis] &gt; 0) {</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>        <span class="keywordflow">for</span> (uint16_t i = 1; i &lt; _state-&gt;_bin_count; i++) {</div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span>            _ref_energy[i][_update_axis] += _state-&gt;get_freq_bin(i);</div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>        }</div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>        <span class="keywordflow">if</span> (--_noise_calibration_cycles[_update_axis] == 0) {</div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span>            <span class="keywordflow">for</span> (uint16_t i = 1; i &lt; _state-&gt;_bin_count; i++) {</div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>                <span class="keyword">const</span> <span class="keywordtype">float</span> cycles = (<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_window_size) / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(_samples_per_frame)) * 2;</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>                <span class="comment">// overall random noise is reduced by sqrt(N) when averaging periodigrams so adjust for that</span></div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>                _ref_energy[i][_update_axis] = (_ref_energy[i][_update_axis] / cycles) * sqrtf(cycles);</div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>            }</div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span> </div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span>            <a class="code hl_define" href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a>(_sem);</div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>            _thread_state._noise_needs_calibration &amp;= ~(1 &lt;&lt; _update_axis);</div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span>        }</div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>    }</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_noise_cycles &gt; 0) {</div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>        _noise_cycles--;</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>    }</div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>}</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span> </div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span><span class="comment">// perform FFT analysis on the range of frequencies supported by the analyser</span></div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span><span class="keywordtype">float</span> AP_GyroFFT::self_test_bin_frequencies()</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>{</div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>    <span class="keywordflow">if</span> (_state-&gt;_window_size * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) &gt; <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">util</a>-&gt;<a class="code hl_function" href="classAP__HAL_1_1Util.html#a2a2e64f649d25593951054d44c0ed53b">available_memory</a>() / 2) {</div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: unable to run self-test, required %u bytes&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(_state-&gt;_window_size * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)));</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>    }</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span> </div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>    <a class="code hl_class" href="classObjectBuffer.html">FloatBuffer</a> test_window(_state-&gt;_window_size);</div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span>    <span class="comment">// in the unlikely event we can&#39;t allocate a test window, skip the checks</span></div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span>    <span class="keywordflow">if</span> (test_window.get_size() == 0) {</div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>    }</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span> </div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>    <span class="keywordtype">float</span> max_divergence = 0;</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span> </div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>    <span class="keywordflow">for</span> (uint16_t bin = _config._fft_start_bin; bin &lt;= _config._fft_end_bin; bin++) {</div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span>        <span class="comment">// the algorithm will only ever return values in this range</span></div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span>        <span class="keywordtype">float</span> frequency = <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(bin * _state-&gt;_bin_resolution, _fft_min_hz, _fft_max_hz);</div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span>        max_divergence = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(max_divergence, self_test(frequency, test_window)); <span class="comment">// test bin centers</span></div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span>        frequency = <a class="code hl_define" href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a>(bin * _state-&gt;_bin_resolution - _state-&gt;_bin_resolution / 4, _fft_min_hz, _fft_max_hz);</div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>        max_divergence = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(max_divergence, self_test(frequency, test_window)); <span class="comment">// test bin off-centers</span></div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>    }</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span> </div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>    <span class="keywordflow">return</span> max_divergence;</div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>}</div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span> </div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span><span class="comment">// perform FFT analysis of a single sine wave at the selected frequency</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span><span class="comment">// called from main thread</span></div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span><span class="keywordtype">float</span> AP_GyroFFT::self_test(<span class="keywordtype">float</span> frequency, <a class="code hl_class" href="classObjectBuffer.html">FloatBuffer</a>&amp; test_window)</div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>{</div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>    test_window.<a class="code hl_function" href="classObjectBuffer.html#ac5b480398372b303469bc01f0fc7553e">clear</a>();</div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>    <span class="keywordflow">for</span>(uint16_t i = 0; i &lt; _state-&gt;_window_size; i++) {</div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>        <span class="keywordflow">if</span> (!test_window.<a class="code hl_function" href="classObjectBuffer.html#aa56aae961e571f5be9d92fbfba7b8803">push</a>(sinf(2.0f * <a class="code hl_define" href="definitions_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * frequency * i / _fft_sampling_rate_hz) * <a class="code hl_define" href="AP__Common_8h.html#a728f9499baea61e7df3ae70a374f2512">ToRad</a>(20) * 2000)) {</div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>            <a class="code hl_function" href="namespaceAP__HAL.html#a52edeef7d5ffaa365e1229b87c170307">AP_HAL::panic</a>(<span class="stringliteral">&quot;Could not create FFT test window&quot;</span>);</div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span>        }</div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span>    }</div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span> </div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>    _update_axis = 0;</div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span> </div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>    <span class="comment">// if using averaging we need to process _num_frames in order to not bias the result</span></div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>    <span class="keywordflow">for</span> (uint8_t i = 1; i &lt; _num_frames; i++) {</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_start(_state, test_window, 0);</div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span>        <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_analyse(_state, _config._fft_start_bin, _config._fft_end_bin, _config._attenuation_cutoff);</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>    }</div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>    <span class="comment">// final cycle is the one we want</span></div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>    <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_start(_state, test_window, 0);</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>    uint16_t max_bin = <a class="code hl_variable" href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a>.<a class="code hl_variable" href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">dsp</a>-&gt;fft_analyse(_state, _config._fft_start_bin, _config._fft_end_bin, _config._attenuation_cutoff);</div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span> </div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span>    <span class="keywordflow">if</span> (max_bin == 0) {</div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: self-test failed, failed to find frequency %.1f&quot;</span>, frequency);</div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>    }</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span> </div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>    <a class="code hl_function" href="AP__InertialSensor__NONE_8cpp.html#a001d4b2e794347cc13cd554c67e2b585">calculate_noise</a>(<span class="keyword">true</span>, _config);</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span> </div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>    <span class="keywordtype">float</span> max_divergence = 0;</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>    <span class="comment">// make sure the selected frequencies are in the right bin</span></div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>    max_divergence = <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(max_divergence, fabsf(frequency - _thread_state._center_freq_hz[0]));</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>    <span class="keywordflow">if</span> (_thread_state._center_freq_hz[0] &lt; (frequency - <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(_state-&gt;_bin_resolution * 0.5f, 1)) || _thread_state._center_freq_hz[0] &gt; (frequency + <a class="code hl_define" href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(_state-&gt;_bin_resolution * 0.5f, 1))) {</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_WARNING, <span class="stringliteral">&quot;FFT: self-test failed: wanted %.1f, had %.1f&quot;</span>, frequency, _thread_state._center_freq_hz[0]);</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>    }</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span><span class="preprocessor">#if DEBUG_FFT</span></div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>    <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>        <a class="code hl_function" href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a>().<a class="code hl_function" href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">send_text</a>(MAV_SEVERITY_INFO, <span class="stringliteral">&quot;FFT: self-test succeeded: wanted %.1f, had %.1f&quot;</span>, frequency, _thread_state._center_freq_hz[0]);</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>    }</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span> </div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>    <span class="keywordflow">return</span> max_divergence;</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span>}</div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span> </div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span><span class="comment">// singleton instance</span></div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>AP_GyroFFT *AP_GyroFFT::_singleton;</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span> </div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceAP.html">AP</a> {</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span> </div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>AP_GyroFFT *fft()</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>{</div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>    <span class="keywordflow">return</span> AP_GyroFFT::get_singleton();</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>}</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span> </div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>}</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span> </div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span><span class="preprocessor">#endif </span><span class="comment">// HAL_GYROFFT_ENABLED</span></div>
<div class="ttc" id="aAC__AttitudeControl_8cpp_html_a240c1a4ae2a70d1855f91e4a0b1ac938"><div class="ttname"><a href="AC__AttitudeControl_8cpp.html#a240c1a4ae2a70d1855f91e4a0b1ac938">hal</a></div><div class="ttdeci">const AP_HAL::HAL &amp; hal</div><div class="ttdef"><b>Definition</b> <a href="AP__Compass__AK09916_8cpp_source.html#l00059">AP_Compass_AK09916.cpp:59</a></div></div>
<div class="ttc" id="aAP__Arming_8h_html"><div class="ttname"><a href="AP__Arming_8h.html">AP_Arming.h</a></div></div>
<div class="ttc" id="aAP__BoardConfig_8h_html"><div class="ttname"><a href="AP__BoardConfig_8h.html">AP_BoardConfig.h</a></div></div>
<div class="ttc" id="aAP__Common_8h_html_a728f9499baea61e7df3ae70a374f2512"><div class="ttname"><a href="AP__Common_8h.html#a728f9499baea61e7df3ae70a374f2512">ToRad</a></div><div class="ttdeci">#define ToRad(x)</div><div class="ttdef"><b>Definition</b> <a href="AP__Common_8h_source.html#l00079">AP_Common.h:79</a></div></div>
<div class="ttc" id="aAP__GyroFFT_8h_html"><div class="ttname"><a href="AP__GyroFFT_8h.html">AP_GyroFFT.h</a></div></div>
<div class="ttc" id="aAP__HAL_2DSP_8h_html_a75ef935b0915d79f84c260398c2aa08f"><div class="ttname"><a href="AP__HAL_2DSP_8h.html#a75ef935b0915d79f84c260398c2aa08f">FFT_MAX_MISSED_UPDATES</a></div><div class="ttdeci">#define FFT_MAX_MISSED_UPDATES</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2DSP_8h_source.html#l00028">DSP.h:28</a></div></div>
<div class="ttc" id="aAP__HAL_2Scheduler_8h_html_a538ef95a13e6bf98cc2e008c2a8b9a44"><div class="ttname"><a href="AP__HAL_2Scheduler_8h.html#a538ef95a13e6bf98cc2e008c2a8b9a44">EXPECT_DELAY_MS</a></div><div class="ttdeci">#define EXPECT_DELAY_MS(ms)</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Scheduler_8h_source.html#l00145">Scheduler.h:145</a></div></div>
<div class="ttc" id="aAP__HAL_2Semaphores_8h_html_a819dd9ac6de800cdf1014b0a922b67d4"><div class="ttname"><a href="AP__HAL_2Semaphores_8h.html#a819dd9ac6de800cdf1014b0a922b67d4">WITH_SEMAPHORE</a></div><div class="ttdeci">#define WITH_SEMAPHORE(sem)</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Semaphores_8h_source.html#l00054">Semaphores.h:54</a></div></div>
<div class="ttc" id="aAP__HAL_2Semaphores_8h_html_ad664d2e6bf70a9194d608eb555dbcf8b"><div class="ttname"><a href="AP__HAL_2Semaphores_8h.html#ad664d2e6bf70a9194d608eb555dbcf8b">HAL_SEMAPHORE_BLOCK_FOREVER</a></div><div class="ttdeci">#define HAL_SEMAPHORE_BLOCK_FOREVER</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Semaphores_8h_source.html#l00007">Semaphores.h:7</a></div></div>
<div class="ttc" id="aAP__InertialSensor__NONE_8cpp_html_a001d4b2e794347cc13cd554c67e2b585"><div class="ttname"><a href="AP__InertialSensor__NONE_8cpp.html#a001d4b2e794347cc13cd554c67e2b585">calculate_noise</a></div><div class="ttdeci">static float calculate_noise(float noise, float noise_variation)</div><div class="ttdef"><b>Definition</b> <a href="AP__InertialSensor__NONE_8cpp_source.html#l00058">AP_InertialSensor_NONE.cpp:58</a></div></div>
<div class="ttc" id="aAP__InertialSensor__config_8h_html_a2247b51f4c9a78d7d1f06d7dda78a82e"><div class="ttname"><a href="AP__InertialSensor__config_8h.html#a2247b51f4c9a78d7d1f06d7dda78a82e">INS_MAX_INSTANCES</a></div><div class="ttdeci">#define INS_MAX_INSTANCES</div><div class="ttdef"><b>Definition</b> <a href="AP__InertialSensor__config_8h_source.html#l00016">AP_InertialSensor_config.h:16</a></div></div>
<div class="ttc" id="aAP__InertialSensor__config_8h_html_a93ac071aee723ba4580dfc8b72ae847f"><div class="ttname"><a href="AP__InertialSensor__config_8h.html#a93ac071aee723ba4580dfc8b72ae847f">XYZ_AXIS_COUNT</a></div><div class="ttdeci">#define XYZ_AXIS_COUNT</div><div class="ttdef"><b>Definition</b> <a href="AP__InertialSensor__config_8h_source.html#l00036">AP_InertialSensor_config.h:36</a></div></div>
<div class="ttc" id="aAP__Logger_8h_html"><div class="ttname"><a href="AP__Logger_8h.html">AP_Logger.h</a></div></div>
<div class="ttc" id="aAP__Math_8h_html_a2a12cce483e9b870da70d30406d82c60"><div class="ttname"><a href="AP__Math_8h.html#a2a12cce483e9b870da70d30406d82c60">is_zero</a></div><div class="ttdeci">bool is_zero(const T fVal1)</div><div class="ttdef"><b>Definition</b> <a href="AP__Math_8h_source.html#l00053">AP_Math.h:53</a></div></div>
<div class="ttc" id="aAP__Math_8h_html_a34f41fcf2bc527b1728ae04423dfba46"><div class="ttname"><a href="AP__Math_8h.html#a34f41fcf2bc527b1728ae04423dfba46">sq</a></div><div class="ttdeci">ftype sq(const T val)</div><div class="ttdef"><b>Definition</b> <a href="AP__Math_8h_source.html#l00225">AP_Math.h:225</a></div></div>
<div class="ttc" id="aAP__Math_8h_html_a40141a958e445f6293a659e856c49f55"><div class="ttname"><a href="AP__Math_8h.html#a40141a958e445f6293a659e856c49f55">constrain_int32</a></div><div class="ttdeci">int32_t constrain_int32(const int32_t amt, const int32_t low, const int32_t high)</div><div class="ttdef"><b>Definition</b> <a href="AP__Math_8h_source.html#l00187">AP_Math.h:187</a></div></div>
<div class="ttc" id="aAP__Math_8h_html_a5256308fd38a7098b8f95607aa56888f"><div class="ttname"><a href="AP__Math_8h.html#a5256308fd38a7098b8f95607aa56888f">constrain_float</a></div><div class="ttdeci">#define constrain_float(amt, low, high)</div><div class="ttdef"><b>Definition</b> <a href="AP__Math_8h_source.html#l00174">AP_Math.h:174</a></div></div>
<div class="ttc" id="aAP__Math_8h_html_a68558c4f79a8582543daefde13c64abc"><div class="ttname"><a href="AP__Math_8h.html#a68558c4f79a8582543daefde13c64abc">constrain_int16</a></div><div class="ttdeci">int16_t constrain_int16(const int16_t amt, const int16_t low, const int16_t high)</div><div class="ttdef"><b>Definition</b> <a href="AP__Math_8h_source.html#l00177">AP_Math.h:177</a></div></div>
<div class="ttc" id="aAP__Motors_8h_html"><div class="ttname"><a href="AP__Motors_8h.html">AP_Motors.h</a></div></div>
<div class="ttc" id="aAP__Motors__test_8cpp_html_ae9423e0933058bde714e7a4c915a7df9"><div class="ttname"><a href="AP__Motors__test_8cpp.html#ae9423e0933058bde714e7a4c915a7df9">motors</a></div><div class="ttdeci">AP_Motors * motors</div><div class="ttdef"><b>Definition</b> <a href="AP__Motors__test_8cpp_source.html#l00040">AP_Motors_test.cpp:40</a></div></div>
<div class="ttc" id="aAP__Param_8h_html_a0f9acb038a5283b964b862aea8cc5051"><div class="ttname"><a href="AP__Param_8h.html#a0f9acb038a5283b964b862aea8cc5051">AP_GROUPEND</a></div><div class="ttdeci">#define AP_GROUPEND</div><div class="ttdef"><b>Definition</b> <a href="AP__Param_8h_source.html#l00163">AP_Param.h:163</a></div></div>
<div class="ttc" id="aAP__Param_8h_html_a78a408c84f2a1bafde256ac650142e4d"><div class="ttname"><a href="AP__Param_8h.html#a78a408c84f2a1bafde256ac650142e4d">AP_GROUPINFO</a></div><div class="ttdeci">#define AP_GROUPINFO(name, idx, clazz, element, def)</div><div class="ttdef"><b>Definition</b> <a href="AP__Param_8h_source.html#l00145">AP_Param.h:145</a></div></div>
<div class="ttc" id="aAP__Param_8h_html_ac24e2eb16c2194e975d27e47ddcb7f1c"><div class="ttname"><a href="AP__Param_8h.html#ac24e2eb16c2194e975d27e47ddcb7f1c">AP_GROUPINFO_FLAGS</a></div><div class="ttdeci">#define AP_GROUPINFO_FLAGS(name, idx, clazz, element, def, flags)</div><div class="ttdef"><b>Definition</b> <a href="AP__Param_8h_source.html#l00133">AP_Param.h:133</a></div></div>
<div class="ttc" id="aAP__Param_8h_html_ae25c1c7495435989f8be5781c86be078"><div class="ttname"><a href="AP__Param_8h.html#ae25c1c7495435989f8be5781c86be078">AP_PARAM_FLAG_ENABLE</a></div><div class="ttdeci">#define AP_PARAM_FLAG_ENABLE</div><div class="ttdef"><b>Definition</b> <a href="AP__Param_8h_source.html#l00087">AP_Param.h:87</a></div></div>
<div class="ttc" id="aAP__Vehicle_8h_html"><div class="ttname"><a href="AP__Vehicle_8h.html">AP_Vehicle.h</a></div></div>
<div class="ttc" id="aDerivativeFilter_8cpp_html_a91f27329cbc70a03207bcee33e2b42fd"><div class="ttname"><a href="DerivativeFilter_8cpp.html#a91f27329cbc70a03207bcee33e2b42fd">x</a></div><div class="ttdeci">#define x(i)</div></div>
<div class="ttc" id="aDerivative_8cpp_html_a430ab649ea04b609ea794c746bfee4ba"><div class="ttname"><a href="Derivative_8cpp.html#a430ab649ea04b609ea794c746bfee4ba">noise</a></div><div class="ttdeci">static float noise(void)</div><div class="ttdef"><b>Definition</b> <a href="Derivative_8cpp_source.html#l00021">Derivative.cpp:21</a></div></div>
<div class="ttc" id="aGCS_8h_html"><div class="ttname"><a href="GCS_8h.html">GCS.h</a></div><div class="ttdoc">Interface definition for the various Ground Control System.</div></div>
<div class="ttc" id="aGCS_8h_html_ab53f292b698f9a6a3f029dfdbd5a43de"><div class="ttname"><a href="GCS_8h.html#ab53f292b698f9a6a3f029dfdbd5a43de">gcs</a></div><div class="ttdeci">GCS &amp; gcs()</div><div class="ttdef"><b>Definition</b> <a href="GCS__Common_8cpp_source.html#l06846">GCS_Common.cpp:6846</a></div></div>
<div class="ttc" id="aHarmonicNotchFilter_8h_html"><div class="ttname"><a href="HarmonicNotchFilter_8h.html">HarmonicNotchFilter.h</a></div></div>
<div class="ttc" id="aHarmonicNotchFilter_8h_html_af1151dca8cefec4b426ce895493bcbcf"><div class="ttname"><a href="HarmonicNotchFilter_8h.html#af1151dca8cefec4b426ce895493bcbcf">HNF_MAX_HARMONICS</a></div><div class="ttdeci">#define HNF_MAX_HARMONICS</div><div class="ttdef"><b>Definition</b> <a href="HarmonicNotchFilter_8h_source.html#l00022">HarmonicNotchFilter.h:22</a></div></div>
<div class="ttc" id="aTransferFunctionCheck_8cpp_html_a10bd73336f20a0e29b5e73449e790798"><div class="ttname"><a href="TransferFunctionCheck_8cpp.html#a10bd73336f20a0e29b5e73449e790798">notch</a></div><div class="ttdeci">NotchHelper notch</div><div class="ttdef"><b>Definition</b> <a href="TransferFunctionCheck_8cpp_source.html#l00072">TransferFunctionCheck.cpp:72</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1HAL_html"><div class="ttname"><a href="classAP__HAL_1_1HAL.html">AP_HAL::HAL</a></div><div class="ttdef"><b>Definition</b> <a href="HAL_8h_source.html#l00021">HAL.h:21</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1HAL_html_a9337a60383f4264fa96a20dbe43a4e2e"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#a9337a60383f4264fa96a20dbe43a4e2e">AP_HAL::HAL::util</a></div><div class="ttdeci">AP_HAL::Util * util</div><div class="ttdef"><b>Definition</b> <a href="HAL_8h_source.html#l00131">HAL.h:131</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1HAL_html_a94ab41309b1ff10b8b862b826e59c882"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#a94ab41309b1ff10b8b862b826e59c882">AP_HAL::HAL::scheduler</a></div><div class="ttdeci">AP_HAL::Scheduler * scheduler</div><div class="ttdef"><b>Definition</b> <a href="HAL_8h_source.html#l00130">HAL.h:130</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1HAL_html_aaddcc6cc698295ee4f0fc6e772ee8329"><div class="ttname"><a href="classAP__HAL_1_1HAL.html#aaddcc6cc698295ee4f0fc6e772ee8329">AP_HAL::HAL::dsp</a></div><div class="ttdeci">AP_HAL::DSP * dsp</div><div class="ttdef"><b>Definition</b> <a href="HAL_8h_source.html#l00134">HAL.h:134</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1Scheduler_html_a78c4f1b1f192ac1c99544b6cc8f099b0"><div class="ttname"><a href="classAP__HAL_1_1Scheduler.html#a78c4f1b1f192ac1c99544b6cc8f099b0">AP_HAL::Scheduler::delay_microseconds</a></div><div class="ttdeci">virtual void delay_microseconds(uint16_t us)=0</div></div>
<div class="ttc" id="aclassAP__HAL_1_1Scheduler_html_aa6ce504fcdbd583bc7c05eb1f1fb2129"><div class="ttname"><a href="classAP__HAL_1_1Scheduler.html#aa6ce504fcdbd583bc7c05eb1f1fb2129">AP_HAL::Scheduler::thread_create</a></div><div class="ttdeci">virtual bool thread_create(AP_HAL::MemberProc proc, const char *name, uint32_t stack_size, priority_base base, int8_t priority)</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Scheduler_8h_source.html#l00124">Scheduler.h:124</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1Scheduler_html_abcee0d195c8bec8bcbe39f3ef6edbf16a85a843892d64d34a41f0c9914e4c6610"><div class="ttname"><a href="classAP__HAL_1_1Scheduler.html#abcee0d195c8bec8bcbe39f3ef6edbf16a85a843892d64d34a41f0c9914e4c6610">AP_HAL::Scheduler::PRIORITY_IO</a></div><div class="ttdeci">@ PRIORITY_IO</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Scheduler_8h_source.html#l00114">Scheduler.h:114</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1Util_html_a2a2e64f649d25593951054d44c0ed53b"><div class="ttname"><a href="classAP__HAL_1_1Util.html#a2a2e64f649d25593951054d44c0ed53b">AP_HAL::Util::available_memory</a></div><div class="ttdeci">virtual uint32_t available_memory(void)</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Util_8h_source.html#l00171">Util.h:171</a></div></div>
<div class="ttc" id="aclassAP__HAL_1_1Util_html_afaedff8102d9ae2fbc398d2099e30cf6"><div class="ttname"><a href="classAP__HAL_1_1Util.html#afaedff8102d9ae2fbc398d2099e30cf6">AP_HAL::Util::snprintf</a></div><div class="ttdeci">int snprintf(char *str, size_t size, const char *format,...) FMT_PRINTF(4</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL_2Util_8cpp_source.html#l00044">Util.cpp:44</a></div></div>
<div class="ttc" id="aclassAP__Logger_html_abab7cb26825a8dfb1e5e92cf7fcf4152"><div class="ttname"><a href="classAP__Logger.html#abab7cb26825a8dfb1e5e92cf7fcf4152">AP_Logger::WriteStreaming</a></div><div class="ttdeci">void WriteStreaming(const char *name, const char *labels, const char *fmt,...)</div><div class="ttdef"><b>Definition</b> <a href="AP__Logger_8cpp_source.html#l00992">AP_Logger.cpp:992</a></div></div>
<div class="ttc" id="aclassAP__Motors_html"><div class="ttname"><a href="classAP__Motors.html">AP_Motors</a></div><div class="ttdef"><b>Definition</b> <a href="AP__Motors__Class_8h_source.html#l00056">AP_Motors_Class.h:56</a></div></div>
<div class="ttc" id="aclassAP__Motors_html_a18a5b7f16341a421c9059b071da8cdf0"><div class="ttname"><a href="classAP__Motors.html#a18a5b7f16341a421c9059b071da8cdf0">AP_Motors::get_throttle_out</a></div><div class="ttdeci">float get_throttle_out() const</div><div class="ttdef"><b>Definition</b> <a href="AP__Motors__Class_8h_source.html#l00157">AP_Motors_Class.h:157</a></div></div>
<div class="ttc" id="aclassAP__Motors_html_a6641c5398dea1388547dff3db5d95a86"><div class="ttname"><a href="classAP__Motors.html#a6641c5398dea1388547dff3db5d95a86">AP_Motors::get_throttle_hover</a></div><div class="ttdeci">virtual float get_throttle_hover() const =0</div></div>
<div class="ttc" id="aclassAP__Notify_html_a1025ca0850b8bf8e2560950352af842a"><div class="ttname"><a href="classAP__Notify.html#a1025ca0850b8bf8e2560950352af842a">AP_Notify::events</a></div><div class="ttdeci">static struct notify_events_type events</div><div class="ttdef"><b>Definition</b> <a href="AP__Notify_8h_source.html#l00174">AP_Notify.h:174</a></div></div>
<div class="ttc" id="aclassAP__Param_html_a5f6dcfce1c0a79cf5bd81283e22f3201"><div class="ttname"><a href="classAP__Param.html#a5f6dcfce1c0a79cf5bd81283e22f3201">AP_Param::setup_object_defaults</a></div><div class="ttdeci">static void setup_object_defaults(const void *object_pointer, const struct GroupInfo *group_info)</div><div class="ttdef"><b>Definition</b> <a href="main_8cpp_source.html#l00010">main.cpp:10</a></div></div>
<div class="ttc" id="aclassGCS_html_a2f099d18721b0874af08fde3f6aae6b6"><div class="ttname"><a href="classGCS.html#a2f099d18721b0874af08fde3f6aae6b6">GCS::send_text</a></div><div class="ttdeci">void send_text(MAV_SEVERITY severity, const char *fmt,...) FMT_PRINTF(3</div><div class="ttdef"><b>Definition</b> <a href="GCS_8cpp_source.html#l00080">GCS.cpp:80</a></div></div>
<div class="ttc" id="aclassObjectBuffer_html"><div class="ttname"><a href="classObjectBuffer.html">ObjectBuffer</a></div><div class="ttdef"><b>Definition</b> <a href="RingBuffer_8h_source.html#l00112">RingBuffer.h:112</a></div></div>
<div class="ttc" id="aclassObjectBuffer_html_a7bac73b321b960c979ac5def005a06f3"><div class="ttname"><a href="classObjectBuffer.html#a7bac73b321b960c979ac5def005a06f3">ObjectBuffer::advance</a></div><div class="ttdeci">bool advance(uint32_t n)</div><div class="ttdef"><b>Definition</b> <a href="RingBuffer_8h_source.html#l00263">RingBuffer.h:263</a></div></div>
<div class="ttc" id="aclassObjectBuffer_html_aa56aae961e571f5be9d92fbfba7b8803"><div class="ttname"><a href="classObjectBuffer.html#aa56aae961e571f5be9d92fbfba7b8803">ObjectBuffer::push</a></div><div class="ttdeci">bool push(const T &amp;object)</div><div class="ttdef"><b>Definition</b> <a href="RingBuffer_8h_source.html#l00175">RingBuffer.h:175</a></div></div>
<div class="ttc" id="aclassObjectBuffer_html_ac5b480398372b303469bc01f0fc7553e"><div class="ttname"><a href="classObjectBuffer.html#ac5b480398372b303469bc01f0fc7553e">ObjectBuffer::clear</a></div><div class="ttdeci">void clear(void)</div><div class="ttdef"><b>Definition</b> <a href="RingBuffer_8h_source.html#l00150">RingBuffer.h:150</a></div></div>
<div class="ttc" id="aclassObjectBuffer_html_ac7dda33e514a9c01c80a7a658cbe640e"><div class="ttname"><a href="classObjectBuffer.html#ac7dda33e514a9c01c80a7a658cbe640e">ObjectBuffer::available</a></div><div class="ttdeci">uint32_t available(void) const</div><div class="ttdef"><b>Definition</b> <a href="RingBuffer_8h_source.html#l00157">RingBuffer.h:157</a></div></div>
<div class="ttc" id="aclassVector3_html"><div class="ttname"><a href="classVector3.html">Vector3&lt; float &gt;</a></div></div>
<div class="ttc" id="aclassVector3_html_a1a0f7e168c71ca798099f0ba8a444244"><div class="ttname"><a href="classVector3.html#a1a0f7e168c71ca798099f0ba8a444244">Vector3::x</a></div><div class="ttdeci">T x</div><div class="ttdef"><b>Definition</b> <a href="vector3_8h_source.html#l00076">vector3.h:76</a></div></div>
<div class="ttc" id="aclassVector3_html_a3d258ebac882ccca247bb65def39ca87"><div class="ttname"><a href="classVector3.html#a3d258ebac882ccca247bb65def39ca87">Vector3::is_nan</a></div><div class="ttdeci">bool is_nan(void) const WARN_IF_UNUSED</div><div class="ttdef"><b>Definition</b> <a href="vector3_8cpp_source.html#l00364">vector3.cpp:364</a></div></div>
<div class="ttc" id="aclassVector3_html_a561df88b28e106e337a25bb86554a569"><div class="ttname"><a href="classVector3.html#a561df88b28e106e337a25bb86554a569">Vector3::y</a></div><div class="ttdeci">T y</div><div class="ttdef"><b>Definition</b> <a href="vector3_8h_source.html#l00076">vector3.h:76</a></div></div>
<div class="ttc" id="aclassVector3_html_ab3e7f5401dd6e951978bfa746809f74f"><div class="ttname"><a href="classVector3.html#ab3e7f5401dd6e951978bfa746809f74f">Vector3::z</a></div><div class="ttdeci">T z</div><div class="ttdef"><b>Definition</b> <a href="vector3_8h_source.html#l00076">vector3.h:76</a></div></div>
<div class="ttc" id="aclassVector3_html_adf1769d5ee5df2f8585df2f540fa5efe"><div class="ttname"><a href="classVector3.html#adf1769d5ee5df2f8585df2f540fa5efe">Vector3::zero</a></div><div class="ttdeci">void zero()</div><div class="ttdef"><b>Definition</b> <a href="vector3_8h_source.html#l00229">vector3.h:229</a></div></div>
<div class="ttc" id="adefinitions_8h_html_ae71449b1cc6e6250b91f539153a7a0d3"><div class="ttname"><a href="definitions_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a></div><div class="ttdeci">#define M_PI</div><div class="ttdef"><b>Definition</b> <a href="definitions_8h_source.html#l00010">definitions.h:10</a></div></div>
<div class="ttc" id="afunctor_8h_html_a00e5874203cecc310017f9166f2c0e36"><div class="ttname"><a href="functor_8h.html#a00e5874203cecc310017f9166f2c0e36">FUNCTOR_BIND_MEMBER</a></div><div class="ttdeci">#define FUNCTOR_BIND_MEMBER(func, rettype,...)</div><div class="ttdef"><b>Definition</b> <a href="functor_8h_source.html#l00031">functor.h:31</a></div></div>
<div class="ttc" id="amonocypher_8cpp_html_a3acffbd305ee72dcd4593c0d8af64a4f"><div class="ttname"><a href="monocypher_8cpp.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a></div><div class="ttdeci">#define MIN(a, b)</div><div class="ttdef"><b>Definition</b> <a href="monocypher_8cpp_source.html#l00071">monocypher.cpp:71</a></div></div>
<div class="ttc" id="amonocypher_8cpp_html_afa99ec4acc4ecb2dc3c2d05da15d0e3f"><div class="ttname"><a href="monocypher_8cpp.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a></div><div class="ttdeci">#define MAX(a, b)</div><div class="ttdef"><b>Definition</b> <a href="monocypher_8cpp_source.html#l00072">monocypher.cpp:72</a></div></div>
<div class="ttc" id="anamespaceAP__HAL_html_a52edeef7d5ffaa365e1229b87c170307"><div class="ttname"><a href="namespaceAP__HAL.html#a52edeef7d5ffaa365e1229b87c170307">AP_HAL::panic</a></div><div class="ttdeci">void panic(const char *errormsg,...) FMT_PRINTF(1</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL__ChibiOS_2system_8cpp_source.html#l00327">system.cpp:327</a></div></div>
<div class="ttc" id="anamespaceAP__HAL_html_a77dffbb18891996280308e21316ec186"><div class="ttname"><a href="namespaceAP__HAL.html#a77dffbb18891996280308e21316ec186">AP_HAL::millis</a></div><div class="ttdeci">uint32_t millis()</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL__ChibiOS_2system_8cpp_source.html#l00377">system.cpp:377</a></div></div>
<div class="ttc" id="anamespaceAP__HAL_html_a7aa0ce7625c9680e30ff4a99940907a5"><div class="ttname"><a href="namespaceAP__HAL.html#a7aa0ce7625c9680e30ff4a99940907a5">AP_HAL::micros64</a></div><div class="ttdeci">uint64_t micros64()</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL__ChibiOS_2system_8cpp_source.html#l00387">system.cpp:387</a></div></div>
<div class="ttc" id="anamespaceAP__HAL_html_a8293355e35887733b1fd151aef08a787"><div class="ttname"><a href="namespaceAP__HAL.html#a8293355e35887733b1fd151aef08a787">AP_HAL::micros</a></div><div class="ttdeci">uint32_t micros()</div><div class="ttdef"><b>Definition</b> <a href="AP__HAL__ChibiOS_2system_8cpp_source.html#l00352">system.cpp:352</a></div></div>
<div class="ttc" id="anamespaceAP_html"><div class="ttname"><a href="namespaceAP.html">AP</a></div><div class="ttdef"><b>Definition</b> <a href="AC__Avoid_8cpp_source.html#l01481">AC_Avoid.cpp:1481</a></div></div>
<div class="ttc" id="anamespaceAP_html_a13852d97b041687ca5df7d76e7207a3d"><div class="ttname"><a href="namespaceAP.html#a13852d97b041687ca5df7d76e7207a3d">AP::arming</a></div><div class="ttdeci">AP_Arming &amp; arming()</div><div class="ttdef"><b>Definition</b> <a href="AP__Arming_8cpp_source.html#l01954">AP_Arming.cpp:1954</a></div></div>
<div class="ttc" id="anamespaceAP_html_a304a59803176ebedc7e4a280c614075b"><div class="ttname"><a href="namespaceAP.html#a304a59803176ebedc7e4a280c614075b">AP::motors</a></div><div class="ttdeci">AP_Motors * motors()</div><div class="ttdef"><b>Definition</b> <a href="AP__Motors__Class_8cpp_source.html#l00305">AP_Motors_Class.cpp:305</a></div></div>
<div class="ttc" id="anamespaceAP_html_aa35bfac1ea2da16f110e8e72db7b3b20"><div class="ttname"><a href="namespaceAP.html#aa35bfac1ea2da16f110e8e72db7b3b20">AP::logger</a></div><div class="ttdeci">AP_Logger &amp; logger()</div><div class="ttdef"><b>Definition</b> <a href="AP__Logger_8cpp_source.html#l01740">AP_Logger.cpp:1740</a></div></div>
<div class="ttc" id="anamespaceAP_html_ac571aa5a2ef71b7f4b4b2bfa09143fb9"><div class="ttname"><a href="namespaceAP.html#ac571aa5a2ef71b7f4b4b2bfa09143fb9">AP::ins</a></div><div class="ttdeci">AP_InertialSensor &amp; ins()</div><div class="ttdef"><b>Definition</b> <a href="AP__InertialSensor_8cpp_source.html#l02780">AP_InertialSensor.cpp:2780</a></div></div>
<div class="ttc" id="astdio_8h_html"><div class="ttname"><a href="stdio_8h.html">stdio.h</a></div></div>
<div class="ttc" id="astdio_8h_html_a55f3d956bb2ba20b5059e9e25484a47f"><div class="ttname"><a href="stdio_8h.html#a55f3d956bb2ba20b5059e9e25484a47f">printf</a></div><div class="ttdeci">int printf(const char *fmt,...)</div></div>
<div class="ttc" id="astructAP__Notify_1_1notify__events__type_html_a3bb4a95fb369e417b93e9dad80421f81"><div class="ttname"><a href="structAP__Notify_1_1notify__events__type.html#a3bb4a95fb369e417b93e9dad80421f81">AP_Notify::notify_events_type::autotune_failed</a></div><div class="ttdeci">uint32_t autotune_failed</div><div class="ttdef"><b>Definition</b> <a href="AP__Notify_8h_source.html#l00154">AP_Notify.h:154</a></div></div>
<div class="ttc" id="astructAP__Notify_1_1notify__events__type_html_a851659a49a3bfcd26822f995577bd1b3"><div class="ttname"><a href="structAP__Notify_1_1notify__events__type.html#a851659a49a3bfcd26822f995577bd1b3">AP_Notify::notify_events_type::autotune_complete</a></div><div class="ttdeci">uint32_t autotune_complete</div><div class="ttdef"><b>Definition</b> <a href="AP__Notify_8h_source.html#l00153">AP_Notify.h:153</a></div></div>
<div class="ttc" id="astructAP__Param_1_1GroupInfo_html"><div class="ttname"><a href="structAP__Param_1_1GroupInfo.html">AP_Param::GroupInfo</a></div><div class="ttdef"><b>Definition</b> <a href="AP__Param_8h_source.html#l00199">AP_Param.h:199</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Mar 22 2024 16:14:14 for APM:Libraries by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
